<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jukebox FF</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
  <style>
    :root { --primary-color: #0693e3; --glow-color: rgba(6, 147, 227, 0.7); }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body { font-family: 'Montserrat', sans-serif; color: #f0f0f0; text-align: center; background-color: #121212; overflow-x: hidden; }
    #background-video { position: fixed; right: 0; bottom: 0; min-width: 100%; min-height: 100%; z-index: -1; object-fit: cover; filter: brightness(0.4); }
    .container-wrapper { min-height: 100vh; width: 100%; display: flex; align-items: center; justify-content: center; padding: 20px; }
    #login-screen, #jukebox-container { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(12px); padding: 40px 30px; max-width: 850px; width: 100%; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1); z-index: 2; }
    h1 { font-size: 2em; margin-bottom: 25px; color: var(--primary-color); }
    h2 { margin-bottom: 25px; font-size: 1.8em; }
    h3 { color: var(--primary-color); margin-bottom: 15px; font-size: 1.4em; }
    input { width: 100%; padding: 14px; border-radius: 25px; border: 1px solid #555; background-color: #2c2c2c; color: #f0f0f0; font-size: 1em; margin-bottom: 20px; text-align: center; }
    .button { display: inline-block; padding: 14px 30px; border: 2px solid var(--primary-color); border-radius: 30px; text-decoration: none; color: #f0f0f0; font-size: 1.1em; font-weight: 500; transition: all 0.3s ease; background-color: transparent; cursor: pointer; width: 100%; }
    .button:hover { background: var(--primary-color); color: white; transform: translateY(-3px); box-shadow: 0 4px 15px var(--glow-color); }
    #jukebox-container { display: none; }
    .header-info { margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 20px; }
    .header-info p { font-size: 1.1em; color: #ccc; line-height: 1.6; }
    .info-box { background-color: rgba(6, 147, 227, 0.1); border-left: 4px solid var(--primary-color); padding: 15px 20px; border-radius: 5px; margin: 25px 0; text-align: left; }
    .info-box ul { list-style: none; padding-left: 0; margin-top: 0; }
    .info-box li { padding-left: 1.5em; position: relative; margin-bottom: 8px; text-align: left; }
    .info-box li:last-child { margin-bottom: 0; }
    .info-box li::before { content: '•'; color: var(--primary-color); font-weight: bold; position: absolute; left: 0.5em; }
    #player-container { width: 100%; max-width: 640px; margin: 25px auto 0; }
    #jukebox-video-player, #jukebox-audio-player { width: 100%; border-radius: 10px; }
    .song-list-container { max-height: 50vh; overflow-y: auto; margin-top: 20px; padding-right: 10px; }
    .song-item { display: flex; align-items: center; gap: 15px; padding: 12px; border-bottom: 1px solid #333; transition: background-color 0.3s ease; border-radius: 5px; }
    .song-item .thumbnail { width: 60px; height: 60px; flex-shrink: 0; border-radius: 8px; object-fit: cover; background-color: #2c2c2c; display: flex; align-items: center; justify-content: center; font-size: 1.8em; }
    .song-item .title-container { flex-grow: 1; text-align: left; }
    .song-item .title { font-size: 1.2em; cursor: pointer; font-weight: 500; }
    .song-details { display: flex; gap: 15px; font-size: 0.85em; color: #bbb; margin-top: 5px; align-items: center; }
    .song-details span { display: flex; align-items: center; gap: 5px; }
    .song-item .actions-container { display: flex; align-items: center; gap: 10px; margin-left: auto; }
    .song-item .btn { background: none; border-radius: 50%; width: 45px; height: 45px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; cursor: pointer; }
    .song-item .play-btn, .song-item .video-btn { border: 2px solid var(--primary-color); color: var(--primary-color); }
    .song-item .lyrics-btn { border: 2px solid #888; color: #888; }
    .song-item .acquista-btn { background-color: #4CAF50; border: 2px solid #4CAF50; color: white; padding: 10px 20px; width: auto; border-radius: 25px; text-decoration: none; font-size: 0.9em; font-weight: 600; white-space: nowrap; margin-left: 15px; }
    .song-item .acquista-btn:disabled { background-color: #555; border-color: #555; color: #999; cursor: not-allowed; }
    .song-item:hover { background-color: rgba(255,255,255,0.05); }
    .song-item.playing-audio .play-btn, .song-item.playing-video .video-btn { background-color: var(--primary-color); color: white; box-shadow: 0 0 15px var(--glow-color); animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 5px var(--glow-color); } 50% { box-shadow: 0 0 20px var(--glow-color); } 100% { box-shadow: 0 0 5px var(--glow-color); } }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal-content { background: #1e1e1e; padding: 30px; border-radius: 15px; width: 100%; max-width: 600px; position: relative; max-height: 80vh; overflow-y: auto; text-align: center; } /* Testo centrato per il nuovo modal */
    .modal-content p { line-height: 1.6; margin-bottom: 20px; }
    .modal-content .button { width: 100%; margin-top: 10px; }
    .modal-close { position: absolute; top: 15px; right: 20px; font-size: 2em; color: white; cursor: pointer; line-height: 1; }
    .no-copy { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
    #contact-form { display: flex; flex-direction: column; gap: 15px; }
    #contact-form input, #contact-form textarea { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #555; background-color: #2c2c2c; color: #f0f0f0; font-size: 1em; }
    #contact-form button { width: auto; align-self: flex-end; }
    .extra-actions { margin-bottom: 30px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
    .extra-actions .button { width: auto; font-size: 1em; padding: 12px 25px; }
  </style>
</head>
<body>

  <video autoplay muted loop playsinline preload="auto" id="background-video">
    <source src="https://github.com/Rickym2025/fausto-fusetti-links/raw/main/video_sfondo_compressed.mp4" type="video/mp4" />
  </video>

  <div class="container-wrapper">
    <div id="login-screen">
      <h1>Jukebox FF Riservato</h1>
      <form id="login-form">
        <input type="email" id="email-input" placeholder="Inserisci la tua email di accesso" required />
        <button type="submit" class="button">Accedi al Jukebox</button>
      </form>
    </div>
    
    <div id="jukebox-container">
      <div class="header-info">
        <h2 style="margin-bottom: 10px;">Jukebox Esclusivo di Fausto Fusetti</h2>
        <p>Musicista, autore, compositore e cantante con oltre 40 anni di esperienza, in collaborazione con giovani talenti del conservatorio.</p>
      </div>
      <div class="extra-actions">
        <!-- Il vecchio link è ora un pulsante che apre il modal -->
        <button id="show-gadget-modal-btn" class="button">
          <i class="fas fa-tshirt"></i> Gadget Personalizzati
        </button>
        <button id="show-custom-request-btn" class="button">
          <i class="fas fa-pen"></i> Richieste Personalizzate
        </button>
      </div>
      <div class="info-box">
        <p style="font-weight: bold; margin-bottom: 10px;">Nota Informativa:</p>
        <ul>
          <li>Brani originali non depositati presso SIAE.</li>
          <li>Limite di 3 ascolti per garantire l'esclusività.</li>
          <li>Tutti i diritti sono riservati.</li>
        </ul>
      </div>
      <div id="song-list-container"><p>Caricamento...</p></div>
      <div id="player-container">
        <video id="jukebox-video-player" style="display: none;" controls></video>
        <audio id="jukebox-audio-player" style="display: none;" controls></audio>
      </div>
    </div>
  </div>

  <div id="lyrics-modal" class="modal-overlay"> <div class="modal-content no-copy" style="text-align: left;"> <span id="lyrics-modal-close" class="modal-close">&times;</span> <h3 id="lyrics-title">Testo della canzone</h3> <p id="lyrics-text">Nessun testo disponibile.</p> </div> </div>
  <div id="contact-modal" class="modal-overlay"> <div class="modal-content"> <span class="modal-close" id="contact-modal-close">&times;</span> <h3>Contattami per il tuo Progetto</h3> <form id="contact-form" action="https://api.web3forms.com/submit" method="POST"> <input type="hidden" name="access_key" value="9013a8d5-0901-42a0-b9e6-4c45553f960d"/> <input type="text" name="name" placeholder="Il tuo Nome" required/> <input type="email" name="email" placeholder="La tua Email" required/> <textarea name="message" rows="4" placeholder="Descrivi la tua richiesta..." required></textarea> <button type="submit" class="button">Invia Messaggio</button> </form> </div> </div>
  
  <!-- NUOVO MODAL PER I GADGET -->
  <div id="gadget-modal" class="modal-overlay">
    <div class="modal-content">
      <span class="modal-close" id="gadget-modal-close">&times;</span>
      <h3><i class="fas fa-gem" style="margin-right: 10px;"></i>Crea la Tua Linea di Gadget Esclusiva</h3>
      <p>
        Vuoi offrire ai tuoi fan qualcosa di unico? Possiamo creare una linea completa di merchandising con il <strong>TUO logo</strong>: magliette, tazze, cappellini e molto altro.
      </p>
      <p>
        Gestiamo tutto noi, dal design alla pubblicazione in un negozio online a tuo nome, <strong>senza costi iniziali</strong>.
      </p>
      <a href="https://ff-music-store.printify.me/" target="_blank" class="button" style="background-color: transparent; margin-bottom: 10px;">
        <i class="fas fa-eye"></i> Guarda un Esempio
      </a>
      <button id="contact-for-gadgets-btn" class="button" style="background-color: var(--primary-color); border-color: var(--primary-color);">
        <i class="fas fa-paper-plane"></i> Richiedi un Preventivo
      </button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Dichiarazione variabili (invariata)
      const loginForm = document.getElementById('login-form');
      const songListContainer = document.getElementById('song-list-container');
      const audioPlayer = document.getElementById('jukebox-audio-player');
      const videoPlayer = document.getElementById('jukebox-video-player');
      const sheetApiUrl = 'https://script.google.com/macros/s/AKfycbxIeTu4FM9_69NM16LgVx1zpFjidw4aIdXAYh871fD5wBrAjs2CEUec0IL94Vnqp8my/exec';
      const MAX_PLAYS = 3;
      let allSongs = [];
      let currentPlayingItem = null;
      let currentPlayingType = null;

      // Gestione Modals
      const lyricsModal = document.getElementById('lyrics-modal');
      const contactModal = document.getElementById('contact-modal');
      const gadgetModal = document.getElementById('gadget-modal'); // <-- Nuovo modal

      const lyricsModalClose = document.getElementById('lyrics-modal-close');
      const contactModalClose = contactModal.querySelector('.modal-close');
      const gadgetModalClose = document.getElementById('gadget-modal-close'); // <-- Nuovo close

      // Prevenzione download (invariata)
      audioPlayer.addEventListener('contextmenu', e => e.preventDefault());
      videoPlayer.addEventListener('contextmenu', e => e.preventDefault());
      lyricsModal.querySelector('.modal-content').addEventListener('contextmenu', e => e.preventDefault());

      // Funzioni di base (invariate)
      function getPlayCounts() { return JSON.parse(localStorage.getItem('songPlayCounts_FF')) || {}; }
      function savePlayCounts(counts) { localStorage.setItem('songPlayCounts_FF', JSON.stringify(counts)); }
      async function trackPlay(songId) { try { const scriptUrlWithoutParams = sheetApiUrl.split('?')[0]; await fetch(scriptUrlWithoutParams, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: songId }) }); } catch (error) { console.error("Impossibile tracciare l'ascolto:", error); } }

      // Logica Login e Caricamento API (invariate)
      loginForm.addEventListener('submit', async function(e) { e.preventDefault(); const email = document.getElementById('email-input').value.trim().toLowerCase(); if (!email) { alert('Per favore, inserisci un\'email.'); return; } const loginButton = this.querySelector('button'); loginButton.textContent = 'Verifico...'; loginButton.disabled = true; try { const validationUrl = `${sheetApiUrl}?emailCheck=${encodeURIComponent(email)}`; const response = await fetch(validationUrl); const result = await response.json(); if (result.status === "ok") { document.getElementById('login-screen').style.display = 'none'; document.getElementById('jukebox-container').style.display = 'block'; loadMusicFromApi(email); } else { alert(result.message || 'Accesso non autorizzato.'); } } catch (error) { alert('Errore di comunicazione con il server. Riprova più tardi.'); } finally { loginButton.textContent = 'Accedi al Jukebox'; loginButton.disabled = false; } });
      async function loadMusicFromApi(userEmail) { songListContainer.innerHTML = `<p>Caricamento brani per ${userEmail}...</p>`; try { const response = await fetch(`${sheetApiUrl}?userEmail=${encodeURIComponent(userEmail)}`); if (!response.ok) throw new Error(`Il server ha risposto con un errore.`); const songs = await response.json(); if (songs.error || songs.status === "error") throw new Error(songs.message || 'Errore restituito dall\'API'); allSongs = songs; displaySongs(); } catch (error) { songListContainer.innerHTML = `<p style="color: #f44336; font-weight: bold;">Errore: ${error.message}.</p>`; } }

      // Funzione displaySongs (invariata, legge i dati già aggiornati dall'API)
      function displaySongs() {
        songListContainer.innerHTML = '';
        if (allSongs.length > 0) {
          allSongs.forEach(song => {
            const hasLyrics = song.liriche && song.liriche.trim() !== "";
            const hasVideo = song.video_url && song.video_url.trim() !== "";
            const thumbnailHTML = song.thumbnail ? `<img src="${song.thumbnail}" class="thumbnail" alt="Thumbnail">` : `<div class="thumbnail"><i class="fas fa-music"></i></div>`;
            const lyricsBtnHTML = hasLyrics ? `<button class="btn lyrics-btn" title="Leggi il testo"><i class="fas fa-file-alt"></i></button>` : '';
            const videoBtnHTML = hasVideo ? `<button class="btn video-btn" title="Guarda il video" data-video-src="${song.video_url}"><i class="fas fa-video"></i></button>` : '';
            let purchaseBtnHTML = '';
            if (song.prezzo) { const buttonText = `Acquista - €${song.prezzo}`; if (song.stripe_link) { purchaseBtnHTML = `<a href="${song.stripe_link}" target="_blank" class="acquista-btn">${buttonText}</a>`; } else { purchaseBtnHTML = `<button class="acquista-btn" disabled>${buttonText}</button>`; } }
            
            let detailsHTML = '';
            if (song.bpm || song.durata) {
                detailsHTML += '<div class="song-details">';
                if (song.bpm) { detailsHTML += `<span><i class="fas fa-heart-pulse"></i> ${song.bpm} BPM</span>`; }
                if (song.durata) { detailsHTML += `<span><i class="fas fa-clock"></i> ${song.durata}</span>`; }
                detailsHTML += '</div>';
            }

            const songItemHTML = `
              <div class="song-item" data-id="${song.id}" data-src="${song.url}" data-title="${song.title}" data-lyrics="${hasLyrics ? song.liriche.replace(/"/g, '&quot;') : ''}">
                ${thumbnailHTML}
                <div class="title-container">
                  <span class="title">${song.title}</span>
                  ${detailsHTML}
                </div>
                <div class="actions-container">
                  ${lyricsBtnHTML}
                  ${videoBtnHTML}
                  <button class="btn play-btn" title="Ascolta l'audio"><i class="fas fa-play"></i></button>
                  ${purchaseBtnHTML}
                </div>
              </div>`;
            songListContainer.innerHTML += songItemHTML;
          });
          addEventListenersToSongs();
        } else {
          songListContainer.innerHTML = '<p>Nessun brano trovato per il tuo account.</p>';
        }
      }
      
      // Funzioni di Playback e UI (invariate)
      function addEventListenersToSongs() { document.querySelectorAll('.song-item').forEach(item => { item.querySelector('.title')?.addEventListener('click', (e) => handlePlay(item, 'audio')); item.querySelector('.play-btn')?.addEventListener('click', (e) => { e.stopPropagation(); handlePlay(item, 'audio'); }); item.querySelector('.video-btn')?.addEventListener('click', (e) => { e.stopPropagation(); handlePlay(item, 'video', e.currentTarget.dataset.videoSrc); }); item.querySelector('.lyrics-btn')?.addEventListener('click', (e) => { e.stopPropagation(); showLyrics(item); }); }); }
      function showLyrics(item) { document.getElementById('lyrics-title').innerText = item.dataset.title; document.getElementById('lyrics-text').innerText = item.dataset.lyrics || "Testo non disponibile."; lyricsModal.style.display = 'flex'; }
      function handlePlay(item, type, videoSrc = null) { const isPlayingThisItem = item === currentPlayingItem; const isSwitchingType = isPlayingThisItem && type !== currentPlayingType; if (isPlayingThisItem && !isSwitchingType) { if (type === 'audio') { audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause(); } else { videoPlayer.paused ? videoPlayer.play() : videoPlayer.pause(); } } else { handlePlayAction(item); resetPlayingState(); currentPlayingItem = item; currentPlayingType = type; if (type === 'audio') { videoPlayer.style.display = 'none'; videoPlayer.pause(); audioPlayer.style.display = 'block'; audioPlayer.src = item.dataset.src; audioPlayer.play(); } else { audioPlayer.style.display = 'none'; audioPlayer.pause(); videoPlayer.style.display = 'block'; videoPlayer.src = videoSrc; videoPlayer.play(); } } }
      function handlePlayAction(item) { const counts = getPlayCounts(); const songId = item.dataset.id; const currentCount = counts[songId] || 0; if (currentCount < MAX_PLAYS) { counts[songId] = currentCount + 1; savePlayCounts(counts); trackPlay(songId); } }
      function resetPlayingState() { if (currentPlayingItem) { currentPlayingItem.classList.remove('playing-audio', 'playing-video'); } currentPlayingItem = null; currentPlayingType = null; }
      function updatePlayingUI() { if (currentPlayingItem) { currentPlayingItem.classList.remove('playing-audio', 'playing-video'); if (currentPlayingType === 'audio') { currentPlayingItem.classList.add('playing-audio'); } else { currentPlayingItem.classList.add('playing-video'); } } }
      function updatePausedUI() { if (currentPlayingItem) { currentPlayingItem.classList.remove('playing-audio', 'playing-video'); } }
      audioPlayer.addEventListener('play', updatePlayingUI); videoPlayer.addEventListener('play', updatePlayingUI);
      audioPlayer.addEventListener('pause', updatePausedUI); videoPlayer.addEventListener('pause', updatePausedUI);
      audioPlayer.addEventListener('ended', resetPlayingState); videoPlayer.addEventListener('ended', resetPlayingState);

      // Gestione chiusura modals
      function setupModal(modal, openBtn, closeBtn) {
        if (openBtn) openBtn.addEventListener('click', () => modal.style.display = 'flex');
        if (closeBtn) closeBtn.addEventListener('click', () => modal.style.display = 'none');
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
      }

      setupModal(lyricsModal, null, lyricsModalClose);
      setupModal(contactModal, document.getElementById('show-custom-request-btn'), contactModalClose);
      setupModal(gadgetModal, document.getElementById('show-gadget-modal-btn'), gadgetModalClose); // <-- Setup nuovo modal
      
      // Logica per il pulsante "Richiedi Preventivo" dentro il modal gadget
      document.getElementById('contact-for-gadgets-btn').addEventListener('click', () => {
        gadgetModal.style.display = 'none'; // Chiude il modal gadget
        contactModal.style.display = 'flex'; // Apre il modal contatti
      });

    });
  </script>

</body>
</html>
