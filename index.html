<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jukebox FF</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    :root { --primary-color: #0693e3; --glow-color: rgba(6, 147, 227, 0.7); --success-color: #4CAF50; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body { font-family: 'Montserrat', sans-serif; color: #f0f0f0; text-align: center; background-color: #121212; overflow-x: hidden; }
    #background-video { position: fixed; right: 0; bottom: 0; min-width: 100%; min-height: 100%; z-index: -1; object-fit: cover; filter: brightness(0.4); }
    .container-wrapper { min-height: 100vh; width: 100%; display: flex; align-items: center; justify-content: center; padding: 120px 20px 50px; }
    .main-content { position: relative; width: 100%; max-width: 850px; }
    .profile-logo { position: absolute; top: 0; left: 50%; transform: translate(-50%, -50%); z-index: 10; }
    .profile-logo-image { width: 160px; height: 160px; border-radius: 50%; border: 6px solid #2c2c2c; box-shadow: 0 5px 25px rgba(0,0,0,0.7); background-image: url('https://pub-89945f8350374b50818d716fdc3c108b.r2.dev/logo%20png.png'); background-size: 180%; background-position: center; }
    #login-screen, #jukebox-container { background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(12px); padding: 40px 30px; padding-top: 100px; width: 100%; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1); }
    #jukebox-container { display: none; }
    h1, h2 { color: var(--primary-color); } h1 { font-size: 2em; margin-bottom: 25px; } h2 { font-size: 1.8em; margin-bottom: 10px; } h3 { color: var(--primary-color); margin-bottom: 20px; font-size: 1.4em; }
    #client-name { color: var(--primary-color); font-size: 1.4em; font-weight: 600; text-shadow: 0 0 8px var(--glow-color); animation: subtle-glow 3s infinite ease-in-out; }
    @keyframes subtle-glow { 0%, 100% { text-shadow: 0 0 8px var(--glow-color); } 50% { text-shadow: 0 0 16px var(--glow-color); } }
    input { width: 100%; padding: 14px; border-radius: 25px; border: 1px solid #555; background-color: #2c2c2c; color: #f0f0f0; font-size: 1em; margin-bottom: 20px; text-align: center; }
    .button { display: inline-block; padding: 14px 30px; border: 2px solid var(--primary-color); border-radius: 30px; text-decoration: none; color: #f0f0f0; font-size: 1.1em; font-weight: 500; transition: all 0.3s ease; background-color: transparent; cursor: pointer; width: 100%; }
    .button:hover { background: var(--primary-color); color: white; transform: translateY(-3px); box-shadow: 0 4px 15px var(--glow-color); }
    #filter-container { display: flex; flex-direction: column; gap: 20px; margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid #444; }
    .filter-group { display: flex; flex-direction: column; align-items: flex-start; gap: 10px; }
    .filter-group .filter-label { font-weight: 600; font-size: 1em; color: var(--primary-color); }
    .filter-buttons { display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-start; }
    .filter-buttons button { background-color: #2c2c2c; border: 1px solid #555; color: #f0f0f0; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 0.85em; transition: all 0.2s ease; }
    .filter-buttons button.active { background-color: var(--primary-color); color: white; }
    .song-list-container { max-height: 45vh; overflow-y: auto; margin-top: 20px; padding-right: 10px; }
    .song-item { display: flex; flex-wrap: wrap; align-items: center; gap: 15px; padding: 15px; border: 1px solid #333; border-radius: 12px; margin-bottom: 15px; background-color: rgba(0,0,0,0.2); transition: opacity 0.3s ease; }
    .song-item-top { display: flex; width: 100%; align-items: center; gap: 15px; }
    .song-info { flex-grow: 1; text-align: left; min-width: 0; }
    .song-info .title { font-size: 1.2em; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; cursor: pointer; }
    .song-details { display: flex; flex-wrap: wrap; gap: 15px; font-size: 0.85em; color: #bbb; margin-top: 5px; align-items: center; }
    .plays-left { font-size: 0.8em; color: #aaa; margin-top: 5px; opacity: 0; transition: opacity 0.3s ease; }
    .song-item:hover .plays-left { opacity: 1; }
    .song-actions { width: 100%; display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; padding-top: 15px; border-top: 1px solid #444; margin-top: 15px;}
    .btn { background: none; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; cursor: pointer; border-width: 2px; border-style: solid; font-family: 'Montserrat', sans-serif; }
    .btn i { font-size: 1.2em; margin-right: 0; }
    .btn:hover { background-color: rgba(255, 255, 255, 0.1); transform: scale(1.1); }
    .info-btn.top-row { border-color: #aaa; color: #aaa; margin-left: auto; }
    .action-btn { font-size: 0.9em; padding: 10px; height: auto; border-radius: 12px; width: 100%; }
    .action-btn i { margin-right: 8px; }
    .action-btn.audio { border-color: #0693e3; color: #0693e3; }
    .action-btn.video { border-color: #e53935; color: #e53935; }
    .action-btn.lyrics { border-color: #757575; color: #757575; }
    .acquista-btn { background-color: var(--success-color); border: 2px solid var(--success-color); color: white; padding: 12px 20px; border-radius: 12px; font-size: 1em; font-weight: 600; text-decoration: none; display: flex; align-items: center; justify-content: center; grid-column: 1 / -1; font-family: 'Montserrat', sans-serif; cursor: pointer; }
    .song-item.playing-audio .action-btn.audio, .song-item.playing-video .action-btn.video { background-color: currentColor; color: white; }
    .song-item.disabled { opacity: 0.5; cursor: not-allowed; }
    .song-item.disabled .title, .song-item.disabled .btn { cursor: not-allowed; }
    .song-item.disabled .plays-left { opacity: 1; color: #f44336; font-weight: 500; }
    .song-item.disabled .action-btn { border-color: #555; color: #777; cursor: not-allowed; }
    .song-item.disabled .action-btn:hover { background-color: transparent; transform: none; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal-content { background: #1e1e1e; padding: 30px; border-radius: 15px; width: 100%; max-width: 600px; position: relative; max-height: 80vh; overflow-y: auto; text-align: center; }
    .modal-close { position: absolute; top: 15px; right: 20px; font-size: 2.5em; color: #aaa; cursor: pointer; line-height: 1; transition: color 0.2s ease; z-index: 1001; }
    .modal-close:hover { color: white; }
    .extra-actions { display: flex; gap: 15px; justify-content: center; margin-bottom: 30px; }
    .extra-actions .button { width: 48%; }
    #video-modal-content video { width: 100%; border-radius: 10px; max-height: 70vh;}
    #contact-modal .modal-content { text-align: left; }
    #contact-form-header { display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #444; padding-bottom: 15px; margin-bottom: 20px; }
    #contact-form-header i { font-size: 1.5em; }
    #contact-form { display: flex; flex-direction: column; gap: 15px; }
    #contact-form input, #contact-form textarea { background-color: #2c2c2c; border: 2px solid #555; border-radius: 10px; color: #f0f0f0; padding: 12px; font-size: 1em; width: 100%; transition: border-color 0.3s ease; }
    #contact-form textarea { resize: vertical; min-height: 120px; }
    #contact-form input:focus, #contact-form textarea:focus { border-color: var(--primary-color); outline: none; }
    #contact-form button { width: auto; align-self: flex-end; }
    #form-result { margin-top: 15px; text-align: right; }
    #footer-player { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); border-top: 1px solid #444; padding: 15px 20px; transform: translateY(100%); transition: transform 0.3s ease-in-out; z-index: 999; display: flex; align-items: center; gap: 15px; }
    #footer-player.visible { transform: translateY(0); }
    #footer-player-title { text-align: left; font-weight: 500; color: #ccc; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
    #jukebox-audio-player { width: 100%; max-width: 500px; height: 40px; }
    .package-list { list-style: none; padding-left: 0; text-align: left; }
    .package-list li { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; font-size: 1em; }
    .package-list li i { color: var(--primary-color); width: 20px; text-align: center; margin-top: 5px; font-size: 1.1em; }
    .package-list li div { text-align: left; }
    .package-list li span { font-size: 0.9em; color: #bbb; }
    #purchase-modal-content h3 { font-size: 1.5em; margin-bottom: 10px; }
    #purchase-modal-content .song-title-highlight { color: var(--primary-color); display: block; font-size: 1.2em; margin-bottom: 25px; font-weight: 600; }
    .upsell-options { text-align: left; margin: 0 auto 25px auto; max-width: 400px; display: flex; flex-direction: column; gap: 15px; }
    .upsell-item { display: flex; align-items: center; gap: 15px; background-color: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; border: 2px solid #444; cursor: pointer; transition: all 0.2s ease-in-out; }
    .upsell-item .check-icon { font-size: 1.2em; color: #555; transition: color 0.2s ease-in-out; }
    .upsell-item.selected { border-color: var(--success-color); background-color: rgba(76, 175, 80, 0.1); }
    .upsell-item.selected .check-icon { color: var(--success-color); }
    .upsell-item-details { text-align: left; }
    .upsell-item-details strong { color: #f0f0f0; font-size: 1.1em; }
    .upsell-item-details span { font-size: 0.9em; color: #bbb; display: block; }
    #purchase-summary { margin-top: 20px; padding-top: 20px; border-top: 1px solid #444; }
    #final-purchase-btn { width: 100%; max-width: 400px; margin: 0 auto; font-size: 1.2em; padding: 15px; }
    @media (max-width: 600px) {
        #footer-player { flex-direction: column; gap: 8px; padding: 10px 15px; }
        #footer-player-title { text-align: center; width: 100%; }
        #jukebox-audio-player { width: 100%; max-width: none; }
        .song-item-top { gap: 10px; }
        .song-info .title { font-size: 1.1em; }
        .info-btn.top-row { width: 40px; height: 40px; flex-shrink: 0; }
        .song-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; }
        .action-btn { padding: 14px 10px; font-size: 0.95em; border-radius: 10px; }
        .song-actions .acquista-btn { grid-column: 1 / -1; padding: 14px; }
        .extra-actions .button { padding: 12px 15px; font-size: 1em; }
    }
  </style>
</head>
<body>

  <video autoplay muted loop playsinline preload="auto" id="background-video"><source src="https://github.com/Rickym2025/fausto-fusetti-links/raw/main/video_sfondo_compressed.mp4" type="video/mp4" /></video>
  
  <div class="container-wrapper">
    <div class="main-content">
        <div class="profile-logo"><div class="profile-logo-image"></div></div>
        <div id="login-screen">
          <h1>Jukebox FF Riservato</h1>
          <form id="login-form">
            <input type="email" id="email-input" placeholder="Inserisci la tua email di accesso" required />
            <button type="submit" class="button">Accedi</button>
          </form>
        </div>
        <div id="jukebox-container">
          <h2>Jukebox Personalizzato</h2>
          <p class="subtitle">per <strong id="client-name"></strong></p>
          <div id="filter-container">
            <div class="filter-group"> <span class="filter-label">Categoria:</span> <div id="filter-categoria" class="filter-buttons"></div> </div>
            <div class="filter-group"> <span class="filter-label">Argomento:</span> <div id="filter-argomento" class="filter-buttons"></div> </div>
            <div class="filter-group"> <span class="filter-label">BPM:</span> <div id="filter-bpm" class="filter-buttons"></div> </div>
          </div>
          <div class="extra-actions">
            <button id="show-gadget-modal-btn" class="button"><i class="fas fa-tshirt"></i> Gadget</button>
            <button id="show-contact-modal-btn" class="button"><i class="fas fa-pen"></i> Richieste</button>
          </div>
          <div id="song-list-container"><p>Caricamento brani...</p></div>
        </div>
    </div>
  </div>
  
  <div id="lyrics-modal" class="modal-overlay"><div class="modal-content no-copy" style="text-align: left;"><span class="modal-close">&times;</span><h3 id="lyrics-title">Testo</h3><p id="lyrics-text"></p></div></div>
  <div id="contact-modal" class="modal-overlay"><div class="modal-content"><span class="modal-close">&times;</span><div id="contact-form-header"><i class="fas fa-pen-nib"></i><h3>Contattami per il tuo Progetto</h3></div><form id="contact-form"><input type="hidden" name="access_key" value="9013a8d5-0901-42a0-b9e6-4c45553f960d"/><input type="text" name="name" placeholder="Il tuo Nome" required/><input type="email" name="email" placeholder="La tua Email" required/><textarea name="message" placeholder="Descrivi la tua idea o richiesta..." required></textarea><button type="submit" class="button">Invia Messaggio</button><div id="form-result"></div></form></div></div>
  <div id="gadget-modal" class="modal-overlay"><div class="modal-content"><span class="modal-close">&times;</span><h3><i class="fas fa-gem"></i>Crea i Tuoi Gadget</h3><p>Crea una linea di merchandising con il <strong>TUO logo</strong>, gestita da noi, <strong>senza costi iniziali</strong>.<br><br></p><a href="https://ff-music-store.printify.me/" target="_blank" class="button" style="background-color: transparent; margin-bottom: 10px;"><i class="fas fa-eye"></i> Guarda un Esempio</a><button id="contact-for-gadgets-btn" class="button" style="background-color: var(--primary-color); border-color: var(--primary-color);"><i class="fas fa-paper-plane"></i> Richiedi un Preventivo</button></div></div>
  <div id="purchase-info-modal" class="modal-overlay"><div class="modal-content"><span class="modal-close">&times;</span><h3>Cosa Ricevi con l'Acquisto?</h3><p style="text-align: left; font-size: 0.9em; color: #ccc;">Finalizzando la transazione, acquisisci la piena proprietà dell'opera. Riceverai immediatamente via email un link per scaricare il pacchetto completo del brano, che include:<br><br></p><ul class="package-list"><li><i class="fas fa-file-contract"></i> <div><strong>Cessione Totale dei Diritti</strong><br><span>Diventi l'unico proprietario dell'opera (Master & Publishing).</span></div></li><li><i class="fas fa-share-alt"></i> <div><strong>Video Promozionale</strong><br><span>Ottimizzato per i tuoi canali social.</span></div></li><li><i class="fas fa-music"></i> <div><strong>Brano Master (.wav)</strong><br><span>Qualità audio professionale non compressa.</span></div></li><li><i class="fas fa-sliders-h"></i> <div><strong>Tracce Separate (.wav)</strong><br><span>Tutti gli strumenti isolati per remix e modifiche.</span></div></li><li><i class="fas fa-file-alt"></i> <div><strong>Testo del Brano (.pdf)</strong><br><span>Testo ufficiale formattato.</span></div></li><li><i class="fas fa-guitar"></i> <div><strong>Spartiti Completi (.pdf)</strong><br><span>Linee melodiche e armonie per Pianoforte e Basso.</span></div></li></ul></div></div>
  <div id="video-modal" class="modal-overlay"><div class="modal-content" id="video-modal-content"><span class="modal-close">&times;</span><video controls controlsList="nodownload" id="jukebox-video-player"></video></div></div>
  <div id="footer-player">
    <span id="footer-player-title">Nessun brano in riproduzione</span>
    <audio controls controlsList="nodownload" id="jukebox-audio-player"></audio>
  </div>

  <div id="purchase-modal" class="modal-overlay">
    <div class="modal-content">
      <span class="modal-close">&times;</span>
      <div id="purchase-modal-content"></div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- CONFIGURAZIONE E VARIABILI GLOBALI ---
    const sheetApiUrl = 'https://script.google.com/macros/s/AKfycbw666DGD4BlSHuJwmVYcRLF9_qMJX2LXy_r6gCGVbjR_dXQDngQU-JttofSKOwUkIJZ/exec?source=jukebox';
    
    // !!! IMPORTANTE: INSERISCI LA TUA CHIAVE PUBBLICABILE DI STRIPE QUI !!!
    const STRIPE_PUBLISHABLE_KEY = "pk_test_51S0GLJLyZ8FXl87PPrgWhBO9RP4ERXMcwT3KQ65JVOYRwYXFsBSohEM7tZE1yDFPusNPcqHK3Ivk8FSNYyj7TdkK00Jeb1SEET"; 
    
    const MAX_PLAYS = 3;
    const RESET_PASSWORD = 'reset_ff_2025';

    let allSongs = [];
    let currentPlayingItem = null;
    let currentPlayingType = null;
    let currentUserEmail = '';

    const loginScreen = document.getElementById('login-screen');
    const jukeboxContainer = document.getElementById('jukebox-container');
    const loginForm = document.getElementById('login-form');
    const contactForm = document.getElementById('contact-form');
    const formResult = document.getElementById('form-result');
    const clientNameEl = document.getElementById('client-name');
    const songListContainer = document.getElementById('song-list-container');
    const audioPlayer = document.getElementById('jukebox-audio-player');
    const videoPlayer = document.getElementById('jukebox-video-player');
    const footerPlayer = document.getElementById('footer-player');
    const footerPlayerTitle = document.getElementById('footer-player-title');
    const modals = { 
        lyrics: document.getElementById('lyrics-modal'), 
        contact: document.getElementById('contact-modal'), 
        gadget: document.getElementById('gadget-modal'), 
        purchaseInfo: document.getElementById('purchase-info-modal'), 
        video: document.getElementById('video-modal'),
        purchase: document.getElementById('purchase-modal')
    };

    setupEventListeners();
    handleResetFromUrl();

    // --- LOGICA DI ACQUISTO CON MODALE INTERATTIVA ---
    function openPurchaseModal(songData) {
        const modalContent = modals.purchase.querySelector('#purchase-modal-content');
        const basePrice = parseFloat(songData.price);
        
        modalContent.innerHTML = `
            <h3>Finalizza il Tuo Acquisto</h3>
            <p>Stai per acquistare il brano:</p>
            <span class="song-title-highlight">${songData.title}</span>
            <div class="upsell-options">
                <div class="upsell-item" data-price="49" data-id="add-video">
                    <i class="fas fa-check-circle check-icon"></i>
                    <div class="upsell-item-details">
                        <strong>Aggiungi Video per Social</strong>
                        <span>Ottimizzato per i tuoi canali (+49.00€)</span>
                    </div>
                </div>
                <div class="upsell-item" data-price="49" data-id="add-gadget">
                    <i class="fas fa-check-circle check-icon"></i>
                    <div class="upsell-item-details">
                        <strong>Aggiungi T-Shirt Brandizzata</strong>
                        <span>Con il tuo logo, design incluso (+49.00€)</span>
                    </div>
                </div>
            </div>
            <div id="purchase-summary">
                <button id="final-purchase-btn" class="acquista-btn">
                    Vai al Pagamento - ${basePrice.toFixed(2)}€
                </button>
            </div>
        `;
        
        modals.purchase.style.display = 'flex';
        
        const finalBtn = modalContent.querySelector('#final-purchase-btn');
        const upsellItems = modalContent.querySelectorAll('.upsell-item');

        const updateTotal = () => {
            let currentTotal = basePrice;
            upsellItems.forEach(item => {
                if (item.classList.contains('selected')) {
                    currentTotal += parseFloat(item.dataset.price);
                }
            });
            finalBtn.textContent = `Vai al Pagamento - ${currentTotal.toFixed(2)}€`;
        };

        upsellItems.forEach(item => {
            item.addEventListener('click', () => {
                item.classList.toggle('selected');
                updateTotal();
            });
        });

        finalBtn.addEventListener('click', () => {
            const addVideo = modalContent.querySelector('.upsell-item[data-id="add-video"]').classList.contains('selected');
            const addGadget = modalContent.querySelector('.upsell-item[data-id="add-gadget"]').classList.contains('selected');
            
            finalBtn.textContent = 'Reindirizzo...';
            finalBtn.disabled = true;

            redirectToDynamicCheckout({
                songId: songData.id,
                songTitle: songData.title,
                songPrice: songData.price,
                songTier: songData.tier,
                addVideo: addVideo,
                addGadget: addGadget,
            });
        });
    }

 function redirectToDynamicCheckout(data) {
    if (!STRIPE_PUBLISHABLE_KEY || !STRIPE_PUBLISHABLE_KEY.startsWith("pk_test_")) {
        alert("Errore: Chiave Pubblicabile di Stripe non configurata.");
        const finalBtn = document.getElementById('final-purchase-btn');
        if (finalBtn) { finalBtn.disabled = false; }
        return;
    }

    // --- CONFIGURAZIONE DEGLI ID DEI PREZZI ---
    // !!! INCOLLA QUI GLI ID CHE HAI COPIATO DALLA TUA DASHBOARD DI STRIPE !!!
    const priceIds = {
        argento: "price_1S5jNgLyZ8FXl87P615MFyDd", 
        oro:     "price_1S5jNgLyZ8FXl87PqUvZChRT",     
        platino: "price_1S5jNgLyZ8FXl87PtN7o5rQj", 
        video:   "price_1S5QcrLyZ8FXl87PipiY314W",    
        gadget:  "price_1S5NN8LyZ8FXl87PRrpQOXDm"  
    };

    const tierKey = data.songTier.toLowerCase();
    const songPriceId = priceIds[tierKey];

    if (!songPriceId || !songPriceId.startsWith("price_")) {
        alert(`Errore: Tier "${data.songTier}" non valido o ID Prezzo non configurato correttamente.`);
        const finalBtn = document.getElementById('final-purchase-btn');
        if (finalBtn) { finalBtn.disabled = false; }
        return;
    }

    // Costruiamo il carrello usando gli ID dei prezzi (metodo corretto)
    const lineItemsPayload = [{
        price: songPriceId,
        quantity: 1
    }];

    if (data.addVideo) {
        lineItemsPayload.push({
            price: priceIds.video,
            quantity: 1
        });
    }
    if (data.addGadget) {
        lineItemsPayload.push({
            price: priceIds.gadget,
            quantity: 1
        });
    }

    console.log("Dati finali inviati a Stripe (con Price ID):", lineItemsPayload);

    const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
    
    stripe.redirectToCheckout({
        lineItems: lineItemsPayload,
        mode: 'payment',
        successUrl: window.location.href.split('?')[0] + '?payment=success',
        cancelUrl: window.location.href.split('?')[0] + '?payment=cancel',
        clientReferenceId: data.songId,
        // Aggiungiamo metadati per sapere il titolo del brano nella dashboard di Stripe
        payment_intent_data: {
            metadata: {
                titolo_brano: data.songTitle,
                id_brano: data.songId
            }
        }
    }).catch(error => {
        console.error("ERRORE DA STRIPE:", error);
        alert("Si è verificato un errore con Stripe. Controlla la console.");
        const finalBtn = document.getElementById('final-purchase-btn');
        if (finalBtn) {
            finalBtn.textContent = 'Errore - Riprova Pagamento';
            finalBtn.disabled = false;
        }
    });
}


    // --- RENDER DEI BRANI ---
    function renderSongs(songsToRender) {
        songListContainer.innerHTML = '';
        if (songsToRender.length > 0) {
            songsToRender.forEach(song => {
                const count = getPlayCounts()[song.id] || 0;
                const playsLeft = MAX_PLAYS - count;
                const isLocked = playsLeft <= 0;

                let purchaseHTML = '';
                if (song.prezzo && song.stato?.toLowerCase() !== 'venduto' && !isLocked) {
                    purchaseHTML = `<button class="acquista-btn open-purchase-modal-btn" 
                        data-song-id="${song.id}"
                        data-song-title="${song.titolo}"
                        data-song-price="${song.prezzo}"
                        data-song-tier="${song.tier}">
                        Acquista da ${parseFloat(song.prezzo).toFixed(2)}€
                        </button>`;
                } else if (song.stato?.toLowerCase() === 'venduto') {
                    purchaseHTML = `<p style="color: #f44336; font-weight: bold; grid-column: 1 / -1; align-self: center;">Brano Venduto</p>`;
                }
                let tierBadge = '';
                if (song.tier) {
                    let tierColor = '#c0c0c0';
                    if (song.tier.toLowerCase().includes('oro')) tierColor = '#ffd700';
                    if (song.tier.toLowerCase().includes('platino')) tierColor = '#e5e4e2';
                    tierBadge = `<span style="background-color: ${tierColor}; color: #121212; padding: 3px 8px; font-size: 0.7em; font-weight: 600; border-radius: 10px; margin-left: 10px;">${song.tier}</span>`;
                }
                const hasLyrics = song.liriche && song.liriche.trim() !== "";
                const hasVideo = song.link_video && song.link_video.trim() !== "";
                const actionAudioBtn = `<button class="btn action-btn audio" title="${isLocked ? 'Limite ascolti' : 'Ascolta'}"><i class="fas ${isLocked ? 'fa-lock' : 'fa-headphones'}"></i> Audio</button>`;
                const actionVideoBtn = hasVideo ? `<button class="btn action-btn video" title="${isLocked ? 'Limite ascolti' : 'Guarda video'}" data-video-src="${song.link_video}"><i class="fas ${isLocked ? 'fa-lock' : 'fa-film'}"></i> Video</button>` : '<div></div>';
                const actionLyricsBtn = hasLyrics ? `<button class="btn action-btn lyrics" title="${isLocked ? 'Limite ascolti' : 'Leggi testo'}"><i class="fas ${isLocked ? 'fa-lock' : 'fa-file-lines'}"></i> Testo</button>` : '<div></div>';
                const infoBtnHTML = `<button class="btn info-btn top-row" title="Cosa include l'acquisto?"><i class="fas fa-info-circle"></i></button>`;
                const detailsHTML = (song.bpm || song.durata) ? `<div class="song-details">${song.bpm ? `<span><i class="fas fa-tachometer-alt"></i> ${song.bpm} BPM</span>` : ''}${song.durata ? `<span><i class="far fa-clock"></i> ${song.durata}</span>` : ''}</div>` : '';
                const playsLeftText = isLocked ? 'Limite ascolti raggiunto' : `Ascolti rimasti: ${playsLeft}`;

                const songItemHTML = `
                    <div class="song-item ${isLocked ? 'disabled' : ''}" data-id="${song.id}" data-src="${song.link_ascolto}" data-title="${song.titolo}" data-lyrics="${hasLyrics ? song.liriche.replace(/"/g, '&quot;') : ''}">
                        <div class="song-item-top">
                            <div class="song-info">
                                <span class="title">${song.titolo}${tierBadge}</span>
                                <div class="plays-left">${playsLeftText}</div>
                                ${detailsHTML}
                            </div>
                            ${infoBtnHTML}
                        </div>
                        <div class="song-actions">
                            ${actionAudioBtn}
                            ${actionVideoBtn}
                            ${actionLyricsBtn}
                            ${purchaseHTML} 
                        </div>
                    </div>`;
                songListContainer.innerHTML += songItemHTML;
            });
        } else {
            songListContainer.innerHTML = '<p>Nessun brano corrisponde ai filtri selezionati.</p>';
        }
    }
    
    // --- SETUP DEGLI EVENT LISTENER ---
    function setupEventListeners() {
        loginForm.addEventListener('submit', handleLogin);
        contactForm.addEventListener('submit', handleContactForm);
        songListContainer.addEventListener('click', function(e) {
            const target = e.target.closest('.btn, .open-purchase-modal-btn, .title');
            if (!target) return;
            const songItem = target.closest('.song-item');
            if (!songItem || songItem.classList.contains('disabled')) return;
            if (target.matches('.open-purchase-modal-btn')) {
                openPurchaseModal({
                    id: target.dataset.songId,
                    title: target.dataset.songTitle,
                    price: target.dataset.songPrice,
                    tier: target.dataset.songTier,
                });
            } else if (target.matches('.action-btn.audio') || target.matches('.title')) {
                handlePlay(songItem, 'audio');
            } else if (target.matches('.action-btn.video')) {
                handlePlay(songItem, 'video', target.dataset.videoSrc);
            } else if (target.matches('.action-btn.lyrics')) {
                showLyrics(songItem);
            } else if (target.matches('.info-btn')) {
                modals.purchaseInfo.style.display = 'flex';
            }
        });
        document.getElementById('show-contact-modal-btn').addEventListener('click', () => modals.contact.style.display = 'flex');
        document.getElementById('show-gadget-modal-btn').addEventListener('click', () => modals.gadget.style.display = 'flex');
        document.getElementById('contact-for-gadgets-btn')?.addEventListener('click', () => { closeAllModals(); modals.contact.style.display = 'flex'; });
        audioPlayer.addEventListener('contextmenu', e => e.preventDefault());
        videoPlayer.addEventListener('contextmenu', e => e.preventDefault());
        audioPlayer.addEventListener('play', updatePlayingUI);
        videoPlayer.addEventListener('play', updatePlayingUI);
        audioPlayer.addEventListener('pause', updatePausedUI);
        videoPlayer.addEventListener('pause', updatePausedUI);
        audioPlayer.addEventListener('ended', resetPlayingState);
        videoPlayer.addEventListener('ended', closeAllModals);
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => { if (e.target === modal) closeAllModals(); });
            modal.querySelector('.modal-close')?.addEventListener('click', () => closeAllModals());
        });
    }

    // --- FUNZIONI CORE (Login, API, Filtri) ---
    async function handleLogin(e) { e.preventDefault(); const email = document.getElementById('email-input').value.trim().toLowerCase(); if (!email) { alert('Per favore, inserisci un\'email.'); return; } currentUserEmail = email; const btn = e.target.querySelector('button'); btn.textContent = 'Verifico...'; btn.disabled = true; try { const url = new URL(sheetApiUrl); url.searchParams.append('emailCheck', email); const res = await fetch(url); if (!res.ok) throw new Error('Errore di rete.'); const result = await res.json(); if (result.status === "ok" && result.name) { loginScreen.style.display = 'none'; jukeboxContainer.style.display = 'block'; clientNameEl.textContent = result.name; await loadMusicFromApi(email); } else { alert(result.message || 'Accesso non autorizzato.'); } } catch (err) { console.error('Errore login:', err); alert('Errore di comunicazione.'); } finally { btn.textContent = 'Accedi'; btn.disabled = false; } }
    async function loadMusicFromApi(userEmail) { songListContainer.innerHTML = `<p>Caricamento...</p>`; try { const url = new URL(sheetApiUrl); url.searchParams.append('userEmail', userEmail); const res = await fetch(url); if (!res.ok) throw new Error('Errore di rete.'); const songs = await res.json(); if (songs.error || songs.status === "error") throw new Error(songs.message || 'Errore API.'); allSongs = songs; populateFilters(allSongs); applyFilters(); } catch (err) { console.error('Errore caricamento:', err); songListContainer.innerHTML = `<p style="color: #f44336;">${err.message}.</p>`; } }
    function populateFilters(songs) { const filters = { categoria: new Set(), argomento: new Set(), bpm: new Set() }; songs.forEach(s => { if (s.categoria) filters.categoria.add(s.categoria); if (s.argomento) filters.argomento.add(s.argomento); if (s.bpm) filters.bpm.add(s.bpm); }); const createBtns = (type, items, label) => { const cont = document.getElementById(`filter-${type}`); if (!cont) return; cont.innerHTML = ''; const allBtn = document.createElement('button'); allBtn.textContent = label; allBtn.value = ''; allBtn.className = 'active'; cont.appendChild(allBtn); [...items].sort((a, b) => isNaN(a) ? a.localeCompare(b) : a - b).forEach(item => { const btn = document.createElement('button'); btn.textContent = item; btn.value = item; cont.appendChild(btn); }); cont.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { cont.querySelectorAll('button').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); applyFilters(); } }); }; createBtns('categoria', filters.categoria, 'Tutte'); createBtns('argomento', filters.argomento, 'Tutti'); createBtns('bpm', filters.bpm, 'Tutti'); }
    function applyFilters() { const getActive = id => document.querySelector(`#filter-${id} button.active`)?.value ?? ''; const cat = getActive('categoria'); const arg = getActive('argomento'); const bpm = getActive('bpm'); const filtered = allSongs.filter(s => (!cat || s.categoria === cat) && (!arg || s.argomento === arg) && (!bpm || String(s.bpm) === bpm)); renderSongs(filtered); }
    
    // --- FUNZIONI PLAYER (CON BUG CORRETTO) ---
    function handlePlay(item, type, sourceUrl = null) {
        const isPlayingThisItem = item === currentPlayingItem && type === currentPlayingType;
        if (isPlayingThisItem) {
            if (type === 'audio') audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause();
            else videoPlayer.paused ? videoPlayer.play() : videoPlayer.pause();
            return;
        }

        const counts = getPlayCounts();
        const songId = item.dataset.id;
        let count = counts[songId] || 0;
        if (count >= MAX_PLAYS) {
            alert("Hai raggiunto il limite di ascolti per questo brano.");
            return;
        }

        // Prima avvia la musica, poi aggiorna i conteggi
        resetPlayingState();
        currentPlayingItem = item;
        currentPlayingType = type;

        if (type === 'audio') {
            footerPlayer.classList.add('visible');
            footerPlayerTitle.textContent = item.dataset.title;
            audioPlayer.src = item.dataset.src;
            audioPlayer.play();
        } else if (type === 'video') {
            videoPlayer.src = sourceUrl;
            modals.video.style.display = 'flex';
            videoPlayer.play();
        }

        // Ora che la musica è partita, aggiorna i conteggi e la UI
        count++;
        counts[songId] = count;
        savePlayCounts(counts);
        trackPlay(songId);
        
        // Aggiorna solo il testo del brano corrente invece di ricaricare tutto
        const playsLeftEl = item.querySelector('.plays-left');
        if (playsLeftEl) {
            const playsLeft = MAX_PLAYS - count;
            if (playsLeft > 0) {
                playsLeftEl.textContent = `Ascolti rimasti: ${playsLeft}`;
            } else {
                item.classList.add('disabled');
                playsLeftEl.textContent = 'Limite ascolti raggiunto';
            }
        }
    }
    
    // --- FUNZIONI HELPER ---
    function getPlayCounts() { if (!currentUserEmail) return {}; return JSON.parse(localStorage.getItem(`jukeboxPlayCounts_${currentUserEmail}`)) || {}; }
    function savePlayCounts(counts) { if (!currentUserEmail) return; localStorage.setItem(`jukeboxPlayCounts_${currentUserEmail}`, JSON.stringify(counts)); }
    async function trackPlay(songId) { try { await fetch(sheetApiUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: songId }) }); } catch (error) { console.error("Impossibile tracciare l'ascolto:", error); } }
    function showLyrics(item) { if (modals.lyrics) { modals.lyrics.querySelector('#lyrics-title').innerText = item.dataset.title; modals.lyrics.querySelector('#lyrics-text').innerText = item.dataset.lyrics || "Testo non disponibile."; modals.lyrics.style.display = 'flex'; } }
    function closeAllModals() { for (const key in modals) { if (modals[key]) modals[key].style.display = 'none'; } videoPlayer.pause(); videoPlayer.src = ''; if (currentPlayingType === 'video') resetPlayingState(); }
    function resetPlayingState() { if (currentPlayingItem) currentPlayingItem.classList.remove('playing-audio', 'playing-video'); currentPlayingItem = null; currentPlayingType = null; footerPlayer.classList.remove('visible'); audioPlayer.pause(); }
    function updatePlayingUI() { if (currentPlayingItem) { document.querySelectorAll('.song-item').forEach(item => item.classList.remove('playing-audio', 'playing-video')); if (currentPlayingType === 'audio') currentPlayingItem.classList.add('playing-audio'); else currentPlayingItem.classList.add('playing-video'); } }
    function updatePausedUI() { document.querySelectorAll('.song-item').forEach(item => item.classList.remove('playing-audio', 'playing-video')); }
    async function handleContactForm(e) { e.preventDefault(); const formData = new FormData(contactForm); formResult.innerHTML = "Invio..."; const submitButton = contactForm.querySelector('button'); submitButton.disabled = true; try { const response = await fetch('https://api.web3forms.com/submit', { method: 'POST', body: formData }); const result = await response.json(); if (result.success) { formResult.innerHTML = "<span style='color: #4CAF50;'>Inviato!</span>"; contactForm.reset(); setTimeout(() => { formResult.innerHTML = ''; closeAllModals(); }, 4000); } else { formResult.innerHTML = `<span style='color: #e53935;'>Errore: ${result.message}</span>`; } } catch (error) { console.error('Errore form:', error); formResult.innerHTML = "<span style='color: #e53935;'>Errore.</span>"; } finally { submitButton.disabled = false; } }
    function handleResetFromUrl() { const urlParams = new URLSearchParams(window.location.search); if (urlParams.get('action') === 'reset' && urlParams.get('password') === RESET_PASSWORD) { const email = urlParams.get('email'); if(email) { localStorage.removeItem(`jukeboxPlayCounts_${email.toLowerCase()}`); window.history.replaceState({}, document.title, window.location.pathname); alert(`Conteggio per ${email} resettato.`); } } }
});
</script>

</body>
</html>
