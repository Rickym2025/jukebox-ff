<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jukebox per Matera</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
  <style>
    :root { 
      --primary-color: #0693e3; 
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body { 
      font-family: 'Montserrat', sans-serif; 
      color: #f0f0f0; 
      text-align: center; 
      background-color: #121212;
      overflow: hidden;
    }
    #background-video { 
      position: fixed; right: 0; bottom: 0; min-width: 100%; min-height: 100%; z-index: -1; object-fit: cover; filter: brightness(0.4); 
    }
    .container-wrapper { 
      min-height: 100vh; width: 100%; display: flex; align-items: center; justify-content: center; padding: 20px; 
    }
    #login-screen, #jukebox-container {
      background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); padding: 40px 30px; max-width: 680px; width: 100%; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1); z-index: 2;
    }
    h1 { font-size: 1.8em; margin-bottom: 25px; color: var(--primary-color); }
    h2 { margin-bottom: 25px; font-size: 1.6em; }
    input { width: 100%; padding: 14px; border-radius: 25px; border: 1px solid #555; background-color: #2c2c2c; color: #f0f0f0; font-size: 1em; margin-bottom: 20px; text-align: center; }
    .button { display: inline-block; padding: 14px 30px; border: 2px solid var(--primary-color); border-radius: 30px; text-decoration: none; color: #f0f0f0; font-size: 1.1em; font-weight: 500; transition: all 0.3s ease; background-color: transparent; cursor: pointer; width: 100%; }
    .button:hover { background: var(--primary-color); color: white; transform: translateY(-3px); box-shadow: 0 4px 15px rgba(6, 147, 227, 0.4); }
    #jukebox-container { display: none; }
    .song-list-container { max-height: 50vh; overflow-y: auto; margin-top: 20px; padding-right: 10px; }
    .song-item { display: flex; align-items: center; gap: 10px; padding: 12px; border-bottom: 1px solid #333; transition: all 0.3s ease; border-radius: 5px; }
    .song-item .title-container { flex-grow: 1; text-align: left; }
    .song-item .title { font-size: 1.1em; cursor: pointer; }
    .song-item .plays-left { font-size: 0.8em; color: #aaa; opacity: 0; transition: opacity 0.3s; }
    .song-item:hover .plays-left { opacity: 1; }
    .song-item .btn { background: none; border: 2px solid var(--primary-color); color: var(--primary-color); border-radius: 50%; width: 40px; height: 40px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; cursor: pointer; }
    .song-item .lyrics-btn { border-color: #aaa; color: #aaa; }
    .song-item:hover { background-color: rgba(255,255,255,0.05); }
    .song-item.playing { background-color: rgba(6, 147, 227, 0.2); }
    .song-item.playing .play-btn { background-color: var(--primary-color); color: white; }
    .song-item.disabled { opacity: 0.5; background-color: transparent !important; cursor: not-allowed; }
    .song-item.disabled .title { cursor: not-allowed; }
    .song-item.disabled .btn { cursor: not-allowed; border-color: #555; color: #555; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal-content { background: #1e1e1e; padding: 30px; border-radius: 15px; width: 100%; max-width: 600px; position: relative; max-height: 80vh; overflow-y: auto; text-align: left; }
    .modal-close { position: absolute; top: 15px; right: 20px; font-size: 2em; color: white; cursor: pointer; line-height: 1; }
    #lyrics-title { color: var(--primary-color); margin-bottom: 20px; }
    #lyrics-text { white-space: pre-wrap; line-height: 1.6; }
    .no-copy { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
  </style>
</head>
<body>

  <video autoplay muted loop playsinline preload="auto" id="background-video">
    <source src="https://github.com/Rickym2025/fausto-fusetti-links/raw/main/video_sfondo_compressed.mp4" type="video/mp4" />
  </video>

  <div class="container-wrapper">
    <div id="login-screen">
      <h1>Jukebox Riservato per MATERA</h1>
      <form id="login-form">
        <input type="email" id="email-input" value="faustofusetti65@gmail.com" placeholder="Inserisci l'email di accesso" required />
        <button type="submit" class="button">Accedi al Jukebox</button>
      </form>
    </div>
    <div id="jukebox-container">
      <h2>Ascolta i Brani</h2>
      <div id="song-list-container"><p>Caricamento...</p></div>
      <audio id="jukebox-audio-player" style="display: none;"></audio>
    </div>
  </div>

  <div id="lyrics-modal" class="modal-overlay">
    <div class="modal-content no-copy"> 
      <span id="lyrics-modal-close" class="modal-close">&times;</span>
      <h3 id="lyrics-title">Testo della canzone</h3>
      <p id="lyrics-text">Nessun testo disponibile.</p>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const loginForm = document.getElementById('login-form');
      const songListContainer = document.getElementById('song-list-container');
      const audioPlayer = document.getElementById('jukebox-audio-player');
      const lyricsModal = document.getElementById('lyrics-modal');
      const lyricsModalClose = document.getElementById('lyrics-modal-close');
      
      // CAMBIA QUI IL NUMERO MASSIMO DI ASCOLTI
      const MAX_PLAYS = 3;
      
      const sheetApiUrl = 'https://script.google.com/macros/s/AKfycbzziUkdI78CZ9vhZ7LNWCFvn6r7JeY2TKuiiDMAdAsAf5uGHZKPsTFJvoy1wxN1wH1t/exec?source=matera';
      
      let allSongs = [];
      let currentPlayingItem = null;

      const modalContent = document.querySelector('#lyrics-modal .modal-content');
      modalContent.addEventListener('contextmenu', (e) => e.preventDefault());

      // --- Funzioni per gestire il LocalStorage ---
      function getPlayCounts() {
        return JSON.parse(localStorage.getItem('songPlayCounts')) || {};
      }
      function savePlayCounts(counts) {
        localStorage.setItem('songPlayCounts', JSON.stringify(counts));
      }

      loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (document.getElementById('email-input').value.trim().toLowerCase() === 'faustofusetti65@gmail.com') {
          document.getElementById('login-screen').style.display = 'none';
          document.getElementById('jukebox-container').style.display = 'block';
          loadMusicFromApi();
        } else {
          alert('Accesso non autorizzato. Email non corretta.');
        }
      });

      async function loadMusicFromApi() {
        try {
          const response = await fetch(sheetApiUrl);
          if (!response.ok) throw new Error(`Il server ha risposto con un errore.`);
          const songs = await response.json();
          if (songs.error || songs.status === "error") throw new Error(songs.message || 'Errore restituito dall\'API');
          allSongs = songs;
          displaySongs();
        } catch (error) {
          songListContainer.innerHTML = `<p style="color: #f44336; font-weight: bold;">Errore: ${error.message}.</p>`;
        }
      }

      function displaySongs() {
        songListContainer.innerHTML = '';
        const playCounts = getPlayCounts();

        if (allSongs.length > 0) {
          allSongs.forEach(song => {
            const count = playCounts[song.id] || 0;
            const playsLeft = MAX_PLAYS - count;
            const isLocked = playsLeft <= 0;
            const hasLyrics = song.liriche && song.liriche.trim() !== "";
            const lyricsData = hasLyrics ? song.liriche.replace(/"/g, '&quot;') : "";

            const songItemHTML = `
              <div class="song-item ${isLocked ? 'disabled' : ''}" data-id="${song.id}" data-src="${song.url}" data-title="${song.title}" data-lyrics="${lyricsData}">
                <div class="title-container">
                    <span class="title">${song.title}</span>
                    <div class="plays-left">${isLocked ? 'Limite ascolti raggiunto' : `Ascolti rimasti: ${playsLeft}`}</div>
                </div>
                ${hasLyrics ? `<button class="btn lyrics-btn" title="Leggi il testo" ${isLocked ? 'disabled' : ''}><i class="fas fa-file-alt"></i></button>` : ''}
                <button class="btn play-btn" ${isLocked ? 'disabled' : ''}>
                    <i class="fas ${isLocked ? 'fa-lock' : 'fa-play'}"></i>
                </button>
              </div>`;
            songListContainer.innerHTML += songItemHTML;
          });
          addEventListenersToSongs();
        } else {
          songListContainer.innerHTML = '<p>Nessun brano trovato.</p>';
        }
      }

      function addEventListenersToSongs() {
        document.querySelectorAll('.song-item').forEach(item => {
          if (item.classList.contains('disabled')) return;

          item.querySelector('.title')?.addEventListener('click', () => handlePlayPause(item));
          item.querySelector('.play-btn')?.addEventListener('click', () => handlePlayPause(item));
          item.querySelector('.lyrics-btn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            const title = item.dataset.title;
            const lyrics = item.dataset.lyrics;
            document.getElementById('lyrics-title').innerText = title;
            document.getElementById('lyrics-text').innerText = lyrics || "Testo non disponibile.";
            lyricsModal.style.display = 'flex';
          });
        });
      }

      function handlePlayPause(item) {
        if (item.classList.contains('disabled')) return;
        const isPlayingThisItem = item === currentPlayingItem;

        if (isPlayingThisItem) {
          audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause();
        } else {
          resetPlayingState(); 
          currentPlayingItem = item;
          audioPlayer.src = item.dataset.src;
          audioPlayer.play();
          
          // Incrementa il contatore solo quando parte un NUOVO brano
          const songId = item.dataset.id;
          const counts = getPlayCounts();
          const currentCount = counts[songId] || 0;
          counts[songId] = currentCount + 1;
          savePlayCounts(counts);

          // Aggiorna la UI
          const playsLeft = MAX_PLAYS - counts[songId];
          const playsLeftEl = item.querySelector('.plays-left');
          if (playsLeft > 0) {
            playsLeftEl.textContent = `Ascolti rimasti: ${playsLeft}`;
          } else {
            playsLeftEl.textContent = 'Limite ascolti raggiunto';
            disableSongItem(item);
          }
        }
      }
      
      function disableSongItem(item) {
        item.classList.add('disabled');
        const playBtn = item.querySelector('.play-btn');
        const lyricsBtn = item.querySelector('.lyrics-btn');
        if (playBtn) {
          playBtn.disabled = true;
          playBtn.querySelector('i').className = 'fas fa-lock';
        }
        if (lyricsBtn) lyricsBtn.disabled = true;
      }

      function resetPlayingState() {
        if (currentPlayingItem) {
          currentPlayingItem.classList.remove('playing');
          const playIcon = currentPlayingItem.querySelector('.play-btn i');
          if(playIcon && !currentPlayingItem.classList.contains('disabled')) {
             playIcon.className = 'fas fa-play';
          }
          currentPlayingItem = null;
        }
      }

      audioPlayer.addEventListener('play', () => {
        if (currentPlayingItem) {
          currentPlayingItem.classList.add('playing');
          const playIcon = currentPlayingItem.querySelector('.play-btn i');
          if(playIcon) playIcon.className = 'fas fa-pause';
        }
      });
      audioPlayer.addEventListener('pause', () => {
        if (currentPlayingItem) {
          currentPlayingItem.classList.remove('playing');
          const playIcon = currentPlayingItem.querySelector('.play-btn i');
          if(playIcon && !currentPlayingItem.classList.contains('disabled')) {
             playIcon.className = 'fas fa-play';
          }
        }
      });
      audioPlayer.addEventListener('ended', resetPlayingState);
      lyricsModalClose.addEventListener('click', () => lyricsModal.style.display = 'none');
      lyricsModal.addEventListener('click', (e) => { if (e.target === lyricsModal) lyricsModal.style.display = 'none'; });
    });
  </script>

</body>
</html>
