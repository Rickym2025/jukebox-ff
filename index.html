<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jukebox FF</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
  <style>
    :root { --primary-color: #0693e3; --glow-color: rgba(6, 147, 227, 0.7); }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body { font-family: 'Montserrat', sans-serif; color: #f0f0f0; text-align: center; background-color: #121212; overflow-x: hidden; }
    #background-video { position: fixed; right: 0; bottom: 0; min-width: 100%; min-height: 100%; z-index: -1; object-fit: cover; filter: brightness(0.4); }
    
    .container-wrapper { min-height: 100vh; width: 100%; display: flex; align-items: center; justify-content: center; padding: 20px; }
    #login-screen, #jukebox-container {
        position: relative;
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(12px);
        padding: 40px 30px;
        padding-top: 100px; /* Spazio per il logo */
        max-width: 850px;
        width: 100%;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 2;
    }
    
    .profile-logo {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10;
    }
    .profile-logo img {
        width: 160px; /* Logo più grande */
        height: 160px;
        border-radius: 50%;
        border: 6px solid #2c2c2c;
        box-shadow: 0 5px 25px rgba(0,0,0,0.7);
    }
    
    h1, h2 { color: var(--primary-color); }
    h1 { font-size: 2em; margin-bottom: 25px; }
    h2 { font-size: 1.8em; margin-bottom: 10px; }
    .subtitle { font-size: 1.1em; color: #ccc; margin-bottom: 25px; }
    input { width: 100%; padding: 14px; border-radius: 25px; border: 1px solid #555; background-color: #2c2c2c; color: #f0f0f0; font-size: 1em; margin-bottom: 20px; text-align: center; }
    .button { display: inline-block; padding: 14px 30px; border: 2px solid var(--primary-color); border-radius: 30px; text-decoration: none; color: #f0f0f0; font-size: 1.1em; font-weight: 500; transition: all 0.3s ease; background-color: transparent; cursor: pointer; width: 100%; }
    .button:hover { background: var(--primary-color); color: white; transform: translateY(-3px); box-shadow: 0 4px 15px var(--glow-color); }
    #jukebox-container { display: none; }

    #filter-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 25px;
        padding-bottom: 25px;
        border-bottom: 1px solid #444;
    }
    .filter-group { display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 10px; }
    .filter-group .filter-label { font-weight: 500; color: #ccc; margin-right: 10px; font-size: 0.9em; }
    .filter-buttons button {
        background-color: #2c2c2c;
        border: 1px solid #555;
        color: #f0f0f0;
        padding: 6px 14px;
        border-radius: 20px;
        cursor: pointer;
        font-family: 'Montserrat', sans-serif;
        font-size: 0.85em;
        transition: all 0.2s ease;
    }
    .filter-buttons button:hover { background-color: #444; }
    .filter-buttons button.active {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
        font-weight: 600;
    }
    
    #player-container { width: 100%; max-width: 640px; margin: 25px auto 0; }
    #jukebox-video-player, #jukebox-audio-player { width: 100%; border-radius: 10px; }
    .song-list-container { max-height: 45vh; overflow-y: auto; margin-top: 20px; padding-right: 10px; }
    .song-item { display: flex; align-items: center; gap: 15px; padding: 12px; border-bottom: 1px solid #333; transition: background-color 0.3s ease; border-radius: 5px; }
    .song-item .thumbnail { width: 60px; height: 60px; flex-shrink: 0; border-radius: 8px; object-fit: cover; background-color: #2c2c2c; display: flex; align-items: center; justify-content: center; font-size: 1.8em; }
    .song-item .title-container { flex-grow: 1; text-align: left; }
    .song-item .title { font-size: 1.2em; cursor: pointer; font-weight: 500; }
    .song-details { display: flex; flex-wrap: wrap; gap: 15px; font-size: 0.85em; color: #bbb; margin-top: 5px; align-items: center; }
    .song-details span { display: flex; align-items: center; gap: 5px; }
    .song-item .actions-container { display: flex; align-items: center; gap: 10px; margin-left: auto; }
    .song-item .btn { background: none; border-radius: 50%; width: 45px; height: 45px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; cursor: pointer; }
    .song-item .play-btn, .song-item .video-btn { border: 2px solid var(--primary-color); color: var(--primary-color); }
    .song-item .lyrics-btn { border: 2px solid #888; color: #888; }
    .song-item .acquista-btn { background-color: #4CAF50; border: 2px solid #4CAF50; color: white; padding: 10px 20px; width: auto; border-radius: 25px; text-decoration: none; font-size: 0.9em; font-weight: 600; white-space: nowrap; margin-left: 15px; }
    .song-item:hover { background-color: rgba(255,255,255,0.05); }
    .song-item.playing-audio .play-btn, .song-item.playing-video .video-btn { background-color: var(--primary-color); color: white; box-shadow: 0 0 15px var(--glow-color); animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 5px var(--glow-color); } 50% { box-shadow: 0 0 20px var(--glow-color); } 100% { box-shadow: 0 0 5px var(--glow-color); } }
  </style>
</head>
<body>

  <video autoplay muted loop playsinline preload="auto" id="background-video">
    <source src="https://github.com/Rickym2025/fausto-fusetti-links/raw/main/video_sfondo_compressed.mp4" type="video/mp4" />
  </video>
  
  <div class="container-wrapper">
    <div id="login-screen">
      <div class="profile-logo">
          <img src="https://pub-89945f8350374b50818d716fdc3c108b.r2.dev/logo%20png.png" alt="Logo FF">
      </div>
      <h1>Jukebox FF Riservato</h1>
      <form id="login-form">
        <input type="email" id="email-input" placeholder="Inserisci la tua email di accesso" required />
        <button type="submit" class="button">Accedi</button>
      </form>
    </div>
    
    <div id="jukebox-container">
      <div class="profile-logo">
          <img src="https://pub-89945f8350374b50818d716fdc3c108b.r2.dev/logo%20png.png" alt="Logo FF">
      </div>
      <h2>Jukebox Personalizzato</h2>
      <p class="subtitle">per <strong id="client-name"></strong></p>
      
      <div id="filter-container">
        <div class="filter-group">
            <span class="filter-label">Categoria:</span>
            <div id="filter-categoria" class="filter-buttons"></div>
        </div>
        <div class="filter-group">
            <span class="filter-label">Argomento:</span>
            <div id="filter-argomento" class="filter-buttons"></div>
        </div>
        <div class="filter-group">
            <span class="filter-label">BPM:</span>
            <div id="filter-bpm" class="filter-buttons"></div>
        </div>
      </div>
      
      <div id="song-list-container"><p>Caricamento brani...</p></div>
      <div id="player-container">
        <video id="jukebox-video-player" style="display: none;" controls controlsList="nodownload"></video>
        <audio id="jukebox-audio-player" style="display: none;" controls controlsList="nodownload"></audio>
      </div>
    </div>
  </div>
  
  <div id="lyrics-modal" class="modal-overlay"> <!-- Modal per i testi (omesso per brevità) --> </div>
  <div id="contact-modal" class="modal-overlay"> <!-- Modal per i contatti (omesso per brevità) --> </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const loginForm = document.getElementById('login-form');
      const jukeboxContainer = document.getElementById('jukebox-container');
      const clientNameEl = document.getElementById('client-name');
      const songListContainer = document.getElementById('song-list-container');
      const sheetApiUrl = 'https://script.google.com/macros/s/AKfycbys4S4YBJZRWZni_kfA3rZIuf56EwVJyCl8ggiQntAxFKY6ZlL96lIpemiU5x4cSttn/exec';
      let allSongs = [];
      // (Altre dichiarazioni di variabili e modals rimangono invariate)

      loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const email = document.getElementById('email-input').value.trim().toLowerCase();
        if (!email) { alert('Per favore, inserisci un\'email.'); return; }
        const loginButton = this.querySelector('button');
        loginButton.textContent = 'Verifico...';
        loginButton.disabled = true;
        try {
          const validationUrl = `${sheetApiUrl}?emailCheck=${encodeURIComponent(email)}`;
          const response = await fetch(validationUrl);
          const result = await response.json();
          if (result.status === "ok" && result.name) {
            document.getElementById('login-screen').style.display = 'none';
            jukeboxContainer.style.display = 'block';
            clientNameEl.textContent = result.name;
            loadMusicFromApi(email);
          } else {
            alert(result.message || 'Accesso non autorizzato o nome non trovato.');
          }
        } catch (error) {
          alert('Errore di comunicazione con il server. Riprova più tardi.');
        } finally {
          loginButton.textContent = 'Accedi';
          loginButton.disabled = false;
        }
      });

      async function loadMusicFromApi(userEmail) {
        songListContainer.innerHTML = `<p>Caricamento brani...</p>`;
        try {
          const response = await fetch(`${sheetApiUrl}?userEmail=${encodeURIComponent(userEmail)}`);
          if (!response.ok) throw new Error(`Il server ha risposto con un errore.`);
          const songs = await response.json();
          if (songs.error) throw new Error(songs.message);
          allSongs = songs;
          populateFilters(allSongs);
          applyFilters();
        } catch (error) {
          songListContainer.innerHTML = `<p style="color: #f44336; font-weight: bold;">Errore: ${error.message}.</p>`;
        }
      }
      
      function populateFilters(songs) {
        const filters = {
            categoria: new Set(),
            argomento: new Set(),
            bpm: new Set()
        };

        songs.forEach(song => {
            if (song.categoria) filters.categoria.add(song.categoria);
            if (song.argomento) filters.argomento.add(song.argomento);
            if (song.bpm) filters.bpm.add(song.bpm);
        });

        const createFilterButtons = (filterType, items) => {
            const container = document.getElementById(`filter-${filterType}`);
            container.innerHTML = ''; // Pulisce i vecchi pulsanti
            
            // Pulsante "Tutti"
            const allButton = document.createElement('button');
            allButton.textContent = 'Tutti';
            allButton.value = '';
            allButton.className = 'active'; // Attivo di default
            container.appendChild(allButton);
            
            // Altri pulsanti
            [...items].sort().forEach(item => {
                const button = document.createElement('button');
                button.textContent = item;
                button.value = item;
                container.appendChild(button);
            });

            // Aggiungi event listener
            container.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    // Gestisce la classe 'active'
                    container.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    applyFilters();
                }
            });
        };

        createFilterButtons('categoria', filters.categoria);
        createFilterButtons('argomento', filters.argomento);
        createFilterButtons('bpm', filters.bpm);
      }

      function applyFilters() {
        const getActiveFilter = (id) => document.querySelector(`#filter-${id} button.active`).value;
        
        const categoria = getActiveFilter('categoria');
        const argomento = getActiveFilter('argomento');
        const bpm = getActiveFilter('bpm');

        const filteredSongs = allSongs.filter(song => {
            const matchCategoria = !categoria || song.categoria === categoria;
            const matchArgomento = !argomento || song.argomento === argomento;
            const matchBpm = !bpm || String(song.bpm) === bpm;
            return matchCategoria && matchArgomento && matchBpm;
        });
        renderSongs(filteredSongs);
      }

      function renderSongs(songsToRender) {
        songListContainer.innerHTML = '';
        if (songsToRender.length > 0) {
          songsToRender.forEach(song => {
            // Questa parte è identica alla versione precedente
            const hasLyrics = song.liriche && song.liriche.trim() !== "";
            const hasVideo = song.video_url && song.video_url.trim() !== "";
            const thumbnailHTML = song.thumbnail ? `<img src="${song.thumbnail}" class="thumbnail" alt="Thumbnail">` : `<div class="thumbnail"><i class="fas fa-music"></i></div>`;
            const lyricsBtnHTML = hasLyrics ? `<button class="btn lyrics-btn" title="Leggi il testo"><i class="fas fa-file-alt"></i></button>` : '';
            const videoBtnHTML = hasVideo ? `<button class="btn video-btn" title="Guarda il video" data-video-src="${song.video_url}"><i class="fas fa-video"></i></button>` : '';
            let purchaseBtnHTML = '';
            if (song.prezzo) { 
                const buttonText = `Acquista - €${song.prezzo}`;
                if (song.stripe_link) {
                    const stripeUrlWithId = `${song.stripe_link}?client_reference_id=${song.id}`;
                    purchaseBtnHTML = `<a href="${stripeUrlWithId}" target="_blank" class="acquista-btn">${buttonText}</a>`;
                } else {
                    purchaseBtnHTML = `<button class="acquista-btn" disabled>${buttonText}</button>`;
                }
            }
            let detailsHTML = '';
            if (song.bpm || song.durata) {
                detailsHTML += '<div class="song-details">';
                if (song.bpm) { detailsHTML += `<span><i class="fas fa-heart-pulse"></i> ${song.bpm} BPM</span>`; }
                if (song.durata) { detailsHTML += `<span><i class="fas fa-clock"></i> ${song.durata}</span>`; }
                detailsHTML += '</div>';
            }
            const songItemHTML = `<div class="song-item" data-id="${song.id}" data-src="${song.url}" data-title="${song.title}" data-lyrics="${hasLyrics ? song.liriche.replace(/"/g, '&quot;') : ''}">${thumbnailHTML}<div class="title-container"><span class="title">${song.title}</span>${detailsHTML}</div><div class="actions-container">${lyricsBtnHTML}${videoBtnHTML}<button class="btn play-btn" title="Ascolta l'audio"><i class="fas fa-play"></i></button>${purchaseBtnHTML}</div></div>`;
            songListContainer.innerHTML += songItemHTML;
          });
          addEventListenersToSongs();
        } else {
          songListContainer.innerHTML = '<p>Nessun brano corrisponde ai filtri selezionati.</p>';
        }
      }
      
      function addEventListenersToSongs() { document.querySelectorAll('.song-item').forEach(item => { item.querySelector('.title')?.addEventListener('click', (e) => handlePlay(item, 'audio')); item.querySelector('.play-btn')?.addEventListener('click', (e) => { e.stopPropagation(); handlePlay(item, 'audio'); }); item.querySelector('.video-btn')?.addEventListener('click', (e) => { e.stopPropagation(); handlePlay(item, 'video', e.currentTarget.dataset.videoSrc); }); item.querySelector('.lyrics-btn')?.addEventListener('click', (e) => { e.stopPropagation(); showLyrics(item); }); }); }
      function showLyrics(item) { document.getElementById('lyrics-title').innerText = item.dataset.title; document.getElementById('lyrics-text').innerText = item.dataset.lyrics || "Testo non disponibile."; modals.lyrics.style.display = 'flex'; }
      function handlePlay(item, type, videoSrc = null) { const isPlayingThisItem = item === currentPlayingItem; const isSwitchingType = isPlayingThisItem && type !== currentPlayingType; if (isPlayingThisItem && !isSwitchingType) { if (type === 'audio') { audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause(); } else { videoPlayer.paused ? videoPlayer.play() : videoPlayer.pause(); } } else { resetPlayingState(); currentPlayingItem = item; currentPlayingType = type; if (type === 'audio') { videoPlayer.style.display = 'none'; videoPlayer.pause(); audioPlayer.style.display = 'block'; audioPlayer.src = item.dataset.src; audioPlayer.play(); } else { audioPlayer.style.display = 'none'; audioPlayer.pause(); videoPlayer.style.display = 'block'; videoPlayer.src = videoSrc; videoPlayer.play(); } } }
      function resetPlayingState() { if (currentPlayingItem) { currentPlayingItem.classList.remove('playing-audio', 'playing-video'); } currentPlayingItem = null; currentPlayingType = null; }
      function updatePlayingUI() { if (currentPlayingItem) { currentPlayingItem.classList.remove('playing-audio', 'playing-video'); if (currentPlayingType === 'audio') { currentPlayingItem.classList.add('playing-audio'); } else { currentPlayingItem.classList.add('playing-video'); } } }
      function updatePausedUI() { if (currentPlayingItem) { currentPlayingItem.classList.remove('playing-audio', 'playing-video'); } }
      audioPlayer.addEventListener('play', updatePlayingUI); videoPlayer.addEventListener('play', updatePlayingUI);
      audioPlayer.addEventListener('pause', updatePausedUI); videoPlayer.addEventListener('pause', updatePausedUI);
      audioPlayer.addEventListener('ended', resetPlayingState); videoPlayer.addEventListener('ended', resetPlayingState);
    });
  </script>

</body>
</html>
