<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jukebox FF</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
  <style>
    /* ... (CSS PRECEDENTE INVARIATO) ... */
    :root { --primary-color: #0693e3; --glow-color: rgba(6, 147, 227, 0.7); }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body { font-family: 'Montserrat', sans-serif; color: #f0f0f0; text-align: center; background-color: #121212; overflow-x: hidden; }
    #background-video { position: fixed; right: 0; bottom: 0; min-width: 100%; min-height: 100%; z-index: -1; object-fit: cover; filter: brightness(0.4); }
    .container-wrapper { min-height: 100vh; width: 100%; display: flex; align-items: center; justify-content: center; padding: 120px 20px 50px; }
    .main-content { position: relative; width: 100%; max-width: 850px; }
    .profile-logo { position: absolute; top: 0; left: 50%; transform: translate(-50%, -50%); z-index: 10; }
    .profile-logo-image { width: 160px; height: 160px; border-radius: 50%; border: 6px solid #2c2c2c; box-shadow: 0 5px 25px rgba(0,0,0,0.7); background-image: url('https://pub-89945f8350374b50818d716fdc3c108b.r2.dev/logo%20png.png'); background-size: 180%; background-position: center; }
    #login-screen, #jukebox-container { background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(12px); padding: 40px 30px; padding-top: 100px; width: 100%; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1); }
    #jukebox-container { display: none; }
    h1, h2 { color: var(--primary-color); } h1 { font-size: 2em; margin-bottom: 25px; } h2 { font-size: 1.8em; margin-bottom: 10px; } h3 { color: var(--primary-color); margin-bottom: 20px; font-size: 1.4em; }
    #client-name { color: var(--primary-color); font-size: 1.4em; font-weight: 600; text-shadow: 0 0 8px var(--glow-color); animation: subtle-glow 3s infinite ease-in-out; }
    @keyframes subtle-glow { 0%, 100% { text-shadow: 0 0 8px var(--glow-color); } 50% { text-shadow: 0 0 16px var(--glow-color); } }
    input { width: 100%; padding: 14px; border-radius: 25px; border: 1px solid #555; background-color: #2c2c2c; color: #f0f0f0; font-size: 1em; margin-bottom: 20px; text-align: center; }
    .button { display: inline-block; padding: 14px 30px; border: 2px solid var(--primary-color); border-radius: 30px; text-decoration: none; color: #f0f0f0; font-size: 1.1em; font-weight: 500; transition: all 0.3s ease; background-color: transparent; cursor: pointer; width: 100%; }
    .button:hover { background: var(--primary-color); color: white; transform: translateY(-3px); box-shadow: 0 4px 15px var(--glow-color); }
    #filter-container { display: flex; flex-direction: column; gap: 20px; margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid #444; }
    .filter-group { display: flex; flex-direction: column; align-items: flex-start; gap: 10px; }
    .filter-group .filter-label { font-weight: 600; font-size: 1em; color: var(--primary-color); }
    .filter-buttons { display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-start; }
    .filter-buttons button { background-color: #2c2c2c; border: 1px solid #555; color: #f0f0f0; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 0.85em; transition: all 0.2s ease; }
    .filter-buttons button.active { background-color: var(--primary-color); color: white; }
    .song-list-container { max-height: 45vh; overflow-y: auto; margin-top: 20px; padding-right: 10px; }
    .song-item { display: flex; flex-wrap: wrap; align-items: center; gap: 15px; padding: 15px; border: 1px solid #333; border-radius: 12px; margin-bottom: 15px; background-color: rgba(0,0,0,0.2); transition: opacity 0.3s ease; }
    .song-item-top { display: flex; width: 100%; align-items: center; gap: 15px; }
    .song-playback-buttons { display: flex; gap: 10px; }
    .song-info { flex-grow: 1; text-align: left; min-width: 0; }
    .song-info .title { font-size: 1.2em; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
    .song-details { display: flex; flex-wrap: wrap; gap: 15px; font-size: 0.85em; color: #bbb; margin-top: 5px; align-items: center; }
    .plays-left { font-size: 0.8em; color: #aaa; margin-top: 5px; opacity: 0; transition: opacity 0.3s ease; }
    .song-item:hover .plays-left { opacity: 1; }
    .song-actions { width: 100%; display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; padding-top: 15px; border-top: 1px solid #444; margin-top: 15px;}
    .song-actions .acquista-btn { grid-column: 1 / -1; }
    .btn { background: none; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; cursor: pointer; border-width: 2px; border-style: solid; font-family: 'Montserrat', sans-serif; }
    .btn i { font-size: 1.2em; margin-right: 0; }
    .btn:hover { background-color: rgba(255, 255, 255, 0.1); transform: scale(1.1); }
    .play-btn, .video-btn { border-color: var(--primary-color); color: var(--primary-color); }
    .info-btn.top-row { border-color: #aaa; color: #aaa; margin-left: auto; }
    .action-btn { font-size: 0.9em; padding: 10px; height: auto; border-radius: 12px; width: 100%; }
    .action-btn i { margin-right: 8px; }
    .action-btn.audio { border-color: #0693e3; color: #0693e3; }
    .action-btn.video { border-color: #e53935; color: #e53935; }
    .action-btn.lyrics { border-color: #757575; color: #757575; }
    .acquista-btn { background-color: #4CAF50; border: 2px solid #4CAF50; color: white; padding: 12px 20px; border-radius: 12px; font-size: 1em; font-weight: 600; text-decoration: none; display: flex; align-items: center; justify-content: center; }
    .song-item.playing-audio .play-btn, .song-item.playing-audio .action-btn.audio, .song-item.playing-video .video-btn, .song-item.playing-video .action-btn.video { background-color: currentColor; color: white; }
    .song-item.disabled { opacity: 0.5; cursor: not-allowed; }
    .song-item.disabled .title, .song-item.disabled .btn { cursor: not-allowed; }
    
    /* --- NUOVO: Stile per il messaggio di brano bloccato --- */
    .song-item.disabled .plays-left {
      opacity: 1; /* Rende il messaggio sempre visibile */
      color: #f44336; /* Colore rosso per evidenziare l'avviso */
      font-weight: 500;
    }
    /* --- NUOVO: Stile per i pulsanti di azione disabilitati --- */
    .song-item.disabled .action-btn {
       border-color: #555;
       color: #777;
       cursor: not-allowed;
    }
    .song-item.disabled .action-btn:hover {
      background-color: transparent;
      transform: none;
    }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal-content { background: #1e1e1e; padding: 30px; border-radius: 15px; width: 100%; max-width: 600px; position: relative; max-height: 80vh; overflow-y: auto; text-align: center; }
    .modal-close { position: absolute; top: 15px; right: 20px; font-size: 2.5em; color: #aaa; cursor: pointer; line-height: 1; transition: color 0.2s ease; z-index: 1001; }
    .modal-close:hover { color: white; }
    .extra-actions { display: flex; gap: 15px; justify-content: center; margin-bottom: 30px; }
    .extra-actions .button { width: 48%; }
    #video-modal-content video { width: 100%; border-radius: 10px; max-height: 70vh;}
    #contact-modal .modal-content { text-align: left; }
    #contact-form-header { display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #444; padding-bottom: 15px; margin-bottom: 20px; }
    #contact-form-header i { font-size: 1.5em; }
    #contact-form { display: flex; flex-direction: column; gap: 15px; }
    #contact-form input, #contact-form textarea { background-color: #2c2c2c; border: 2px solid #555; border-radius: 10px; color: #f0f0f0; padding: 12px; font-size: 1em; width: 100%; transition: border-color 0.3s ease; }
    #contact-form textarea { resize: vertical; min-height: 120px; }
    #contact-form input:focus, #contact-form textarea:focus { border-color: var(--primary-color); outline: none; }
    #contact-form button { width: auto; align-self: flex-end; }
    #form-result { margin-top: 15px; text-align: right; }
    #footer-player { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); border-top: 1px solid #444; padding: 15px 20px; transform: translateY(100%); transition: transform 0.3s ease-in-out; z-index: 999; display: flex; align-items: center; gap: 15px; }
    #footer-player.visible { transform: translateY(0); }
    #footer-player-title { text-align: left; font-weight: 500; color: #ccc; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
    #jukebox-audio-player { width: 100%; max-width: 500px; height: 40px; }
    .package-list { list-style: none; padding-left: 0; text-align: left; }
    .package-list li { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; font-size: 1em; }
    .package-list li i { color: var(--primary-color); width: 20px; text-align: center; margin-top: 5px; font-size: 1.1em; }
    .package-list li div { text-align: left; }
    .package-list li span { font-size: 0.9em; color: #bbb; }

    /* --- INIZIO SEZIONE RESPONSIVE OTTIMIZZATA PER MOBILE --- */
    @media (max-width: 600px) {
      /* --- NUOVO: Player su due righe --- */
      #footer-player {
        flex-direction: column; /* Stack verticale: Titolo sopra, player sotto */
        gap: 8px; /* Spazio tra titolo e player */
        padding: 10px 15px; /* Padding più compatto */
      }
      #footer-player-title {
        text-align: center;
        width: 100%;
      }
      #jukebox-audio-player {
        width: 100%; /* Player occupa tutta la larghezza */
        max-width: none;
      }
    
      /* 1. ELIMINA I PULSANTI TONDI DI PLAYBACK (MP3/MP4) */
      .song-playback-buttons {
        display: none;
      }

      /* 2. ADATTA IL LAYOUT SUPERIORE DEL BRANO */
      .song-item-top {
        gap: 10px;
      }
      .song-info .title {
        font-size: 1.1em;
      }
       /* Mantiene il pulsante info in alto a destra di dimensioni corrette */
      .info-btn.top-row {
          width: 40px;
          height: 40px;
          flex-shrink: 0;
      }

      /* 3. RENDI I PULSANTI DI AZIONE RETTANGOLARI, PIÙ GRANDI E CLICCABILI */
      .song-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 12px;
      }
      .action-btn {
        padding: 14px 10px;
        font-size: 0.95em;
        border-radius: 10px;
      }
      .song-actions .acquista-btn {
        grid-column: 1 / -1;
        padding: 14px;
      }
      .extra-actions .button {
        padding: 12px 15px;
        font-size: 1em;
      }
    }
    /* --- FINE SEZIONE RESPONSIVE OTTIMIZZATA PER MOBILE --- */

  </style>
</head>
<body>

  <video autoplay muted loop playsinline preload="auto" id="background-video"><source src="https://github.com/Rickym2025/fausto-fusetti-links/raw/main/video_sfondo_compressed.mp4" type="video/mp4" /></video>
  
  <div class="container-wrapper">
    <div class="main-content">
        <div class="profile-logo"><div class="profile-logo-image"></div></div>
        <div id="login-screen">
          <h1>Jukebox FF Riservato</h1>
          <form id="login-form">
            <input type="email" id="email-input" placeholder="Inserisci la tua email di accesso" required />
            <button type="submit" class="button">Accedi</button>
          </form>
        </div>
        <div id="jukebox-container">
          <h2>Jukebox Personalizzato</h2>
          <p class="subtitle">per <strong id="client-name"></strong></p>
          <div id="filter-container">
            <div class="filter-group"> <span class="filter-label">Categoria:</span> <div id="filter-categoria" class="filter-buttons"></div> </div>
            <div class="filter-group"> <span class="filter-label">Argomento:</span> <div id="filter-argomento" class="filter-buttons"></div> </div>
            <div class="filter-group"> <span class="filter-label">BPM:</span> <div id="filter-bpm" class="filter-buttons"></div> </div>
          </div>
          <div class="extra-actions">
            <button id="show-gadget-modal-btn" class="button"><i class="fas fa-tshirt"></i> Gadget</button>
            <button id="show-contact-modal-btn" class="button"><i class="fas fa-pen"></i> Richieste</button>
          </div>
          <div id="song-list-container"><p>Caricamento brani...</p></div>
        </div>
    </div>
  </div>
  
  <!-- ... (MODAL E FOOTER HTML INVARIATI) ... -->
  <div id="lyrics-modal" class="modal-overlay"><div class="modal-content no-copy" style="text-align: left;"><span class="modal-close">&times;</span><h3 id="lyrics-title">Testo</h3><p id="lyrics-text"></p></div></div>
  <div id="contact-modal" class="modal-overlay"><div class="modal-content"><span class="modal-close">&times;</span><div id="contact-form-header"><i class="fas fa-pen-nib"></i><h3>Contattami per il tuo Progetto</h3></div><form id="contact-form"><input type="hidden" name="access_key" value="9013a8d5-0901-42a0-b9e6-4c45553f960d"/><input type="text" name="name" placeholder="Il tuo Nome" required/><input type="email" name="email" placeholder="La tua Email" required/><textarea name="message" placeholder="Descrivi la tua idea o richiesta..." required></textarea><button type="submit" class="button">Invia Messaggio</button><div id="form-result"></div></form></div></div>
  <div id="gadget-modal" class="modal-overlay"><div class="modal-content"><span class="modal-close">&times;</span><h3><i class="fas fa-gem"></i>Crea i Tuoi Gadget</h3><p>Crea una linea di merchandising con il <strong>TUO logo</strong>, gestita da noi, <strong>senza costi iniziali</strong>.<br><br></p><a href="https://ff-music-store.printify.me/" target="_blank" class="button" style="background-color: transparent; margin-bottom: 10px;"><i class="fas fa-eye"></i> Guarda un Esempio</a><button id="contact-for-gadgets-btn" class="button" style="background-color: var(--primary-color); border-color: var(--primary-color);"><i class="fas fa-paper-plane"></i> Richiedi un Preventivo</button></div></div>
  <div id="purchase-info-modal" class="modal-overlay"><div class="modal-content"><span class="modal-close">&times;</span><h3>Cosa Ricevi con l'Acquisto?</h3><p style="text-align: left; font-size: 0.9em; color: #ccc;">Finalizzando la transazione, acquisisci la piena proprietà dell'opera. Riceverai immediatamente via email un link per scaricare il pacchetto completo del brano, che include:<br><br></p><ul class="package-list"><li><i class="fas fa-file-contract"></i> <div><strong>Cessione Totale dei Diritti</strong><br><span>Diventi l'unico proprietario dell'opera (Master & Publishing).</span></div></li><li><i class="fas fa-share-alt"></i> <div><strong>Video Promozionale</strong><br><span>Ottimizzato per i tuoi canali social.</span></div></li><li><i class="fas fa-music"></i> <div><strong>Brano Master (.wav)</strong><br><span>Qualità audio professionale non compressa.</span></div></li><li><i class="fas fa-sliders-h"></i> <div><strong>Tracce Separate (.wav)</strong><br><span>Tutti gli strumenti isolati per remix e modifiche.</span></div></li><li><i class="fas fa-file-alt"></i> <div><strong>Testo del Brano (.pdf)</strong><br><span>Testo ufficiale formattato.</span></div></li><li><i class="fas fa-guitar"></i> <div><strong>Spartiti Completi (.pdf)</strong><br><span>Linee melodiche e armonie per Pianoforte e Basso.</span></div></li></ul></div></div>
  <div id="video-modal" class="modal-overlay"><div class="modal-content" id="video-modal-content"><span class="modal-close">&times;</span><video controls controlsList="nodownload" id="jukebox-video-player"></video></div></div>

  <div id="footer-player">
    <span id="footer-player-title">Nessun brano in riproduzione</span>
    <audio controls controlsList="nodownload" id="jukebox-audio-player"></audio>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // --- (DICHIARAZIONI E FUNZIONI PRECEDENTI INVARIATE) ---
      const loginScreen = document.getElementById('login-screen');
      const jukeboxContainer = document.getElementById('jukebox-container');
      const loginForm = document.getElementById('login-form');
      const contactForm = document.getElementById('contact-form');
      const formResult = document.getElementById('form-result');
      const clientNameEl = document.getElementById('client-name');
      const songListContainer = document.getElementById('song-list-container');
      const audioPlayer = document.getElementById('jukebox-audio-player');
      const videoPlayer = document.getElementById('jukebox-video-player');
      const footerPlayer = document.getElementById('footer-player');
      const footerPlayerTitle = document.getElementById('footer-player-title');
      const sheetApiUrl = 'https://script.google.com/macros/s/AKfycbw666DGD4BlSHuJwmVYcRLF9_qMJX2LXy_r6gCGVbjR_dXQDngQU-JttofSKOwUkIJZ/exec?source=jukebox';
      const MAX_PLAYS = 3;
      let allSongs = [];
      let currentPlayingItem = null;
      let currentPlayingType = null;
      let currentUserEmail = '';
      
      const modals = { lyrics: document.getElementById('lyrics-modal'), contact: document.getElementById('contact-modal'), gadget: document.getElementById('gadget-modal'), purchaseInfo: document.getElementById('purchase-info-modal'), video: document.getElementById('video-modal') };
      
      function closeAllModals() {
        for (const key in modals) { if(modals[key]) modals[key].style.display = 'none'; }
        videoPlayer.pause();
        videoPlayer.src = '';
        if(currentPlayingType === 'video') { resetPlayingState(); }
      }
      document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', (e) => { if (e.target === modal) closeAllModals(); });
        const closeBtn = modal.querySelector('.modal-close');
        if(closeBtn) closeBtn.addEventListener('click', () => closeAllModals());
      });
      document.getElementById('show-contact-modal-btn').addEventListener('click', () => modals.contact.style.display = 'flex');
      document.getElementById('show-gadget-modal-btn').addEventListener('click', () => modals.gadget.style.display = 'flex');
      const contactForGadgetsBtn = document.getElementById('contact-for-gadgets-btn');
      if(contactForGadgetsBtn) contactForGadgetsBtn.addEventListener('click', () => { closeAllModals(); modals.contact.style.display = 'flex'; });

      audioPlayer.addEventListener('contextmenu', e => e.preventDefault());
      videoPlayer.addEventListener('contextmenu', e => e.preventDefault());

      function getPlayCounts() {
        if (!currentUserEmail) return {};
        const key = `jukeboxPlayCounts_${currentUserEmail}`;
        return JSON.parse(localStorage.getItem(key)) || {};
      }
      function savePlayCounts(counts) {
        if (!currentUserEmail) return;
        const key = `jukeboxPlayCounts_${currentUserEmail}`;
        localStorage.setItem(key, JSON.stringify(counts));
      }

      async function trackPlay(songId) {
        try {
          const url = new URL(sheetApiUrl);
          await fetch(url, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: songId })
          });
        } catch (error) { console.error("Impossibile tracciare l'ascolto:", error); }
      }
      
      loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const email = document.getElementById('email-input').value.trim().toLowerCase();
        if (!email) { alert('Per favore, inserisci un\'email.'); return; }
        currentUserEmail = email;
        const loginButton = this.querySelector('button');
        loginButton.textContent = 'Verifico...';
        loginButton.disabled = true;
        try {
          const url = new URL(sheetApiUrl);
          url.searchParams.append('emailCheck', email);
          const response = await fetch(url);
          if (!response.ok) throw new Error('Errore di rete o del server.');
          const result = await response.json();
          if (result.status === "ok" && result.name) {
            loginScreen.style.display = 'none';
            jukeboxContainer.style.display = 'block';
            clientNameEl.textContent = result.name;
            await loadMusicFromApi(email);
          } else {
            alert(result.message || 'Accesso non autorizzato o nome non trovato.');
          }
        } catch (error) {
          console.error('Errore durante il login:', error);
          alert('Errore di comunicazione con il server. Assicurati che l\'URL dello script sia corretto e che la distribuzione sia attiva.');
        } finally {
          loginButton.textContent = 'Accedi';
          loginButton.disabled = false;
        }
      });
      
      contactForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(contactForm);
        formResult.innerHTML = "Invio in corso...";
        const submitButton = contactForm.querySelector('button');
        submitButton.disabled = true;
        try {
            const response = await fetch('https://api.web3forms.com/submit', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if (result.success) {
                formResult.innerHTML = "<span style='color: #4CAF50;'>Messaggio inviato con successo!</span>";
                contactForm.reset();
                setTimeout(() => { formResult.innerHTML = ''; closeAllModals(); }, 4000);
            } else {
                formResult.innerHTML = `<span style='color: #e53935;'>Errore: ${result.message}</span>`;
            }
        } catch (error) {
            console.error('Errore invio form:', error);
            formResult.innerHTML = "<span style='color: #e53935;'>Errore nell'invio del messaggio.</span>";
        } finally {
            submitButton.disabled = false;
        }
      });

      async function loadMusicFromApi(userEmail) {
        songListContainer.innerHTML = `<p>Caricamento brani...</p>`;
        try {
          const url = new URL(sheetApiUrl);
          url.searchParams.append('userEmail', userEmail);
          const response = await fetch(url);
          if (!response.ok) throw new Error('Errore di rete o del server.');
          const songs = await response.json();
          if (songs.error || songs.status === "error") throw new Error(songs.message || 'Errore restituito dall\'API');
          allSongs = songs;
          populateFilters(allSongs);
          applyFilters();
        } catch (error) {
          console.error('Errore durante il caricamento dei brani:', error);
          songListContainer.innerHTML = `<p style="color: #f44336; font-weight: bold;">Errore: ${error.message}.</p>`;
        }
      }
      
      function populateFilters(songs) {
        const filters = { categoria: new Set(), argomento: new Set(), bpm: new Set() };
        songs.forEach(song => {
            if (song.categoria) filters.categoria.add(song.categoria);
            if (song.argomento) filters.argomento.add(song.argomento);
            if (song.bpm) filters.bpm.add(song.bpm);
        });
        const createFilterButtons = (filterType, items, allLabel) => {
            const container = document.getElementById(`filter-${filterType}`);
            if(!container) return;
            container.innerHTML = '';
            const allButton = document.createElement('button');
            allButton.textContent = allLabel;
            allButton.value = '';
            allButton.className = 'active';
            container.appendChild(allButton);
            [...items].sort((a, b) => isNaN(a) ? a.localeCompare(b) : a - b).forEach(item => {
                const button = document.createElement('button');
                button.textContent = item;
                button.value = item;
                container.appendChild(button);
            });
            container.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    container.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    applyFilters();
                }
            });
        };
        createFilterButtons('categoria', filters.categoria, 'Tutte le Categorie');
        createFilterButtons('argomento', filters.argomento, 'Tutti gli Argomenti');
        createFilterButtons('bpm', filters.bpm, 'Tutti i BPM');
      }

      function applyFilters() {
        const getActiveFilter = (id) => document.querySelector(`#filter-${id} button.active`)?.value ?? '';
        const categoria = getActiveFilter('categoria');
        const argomento = getActiveFilter('argomento');
        const bpm = getActiveFilter('bpm');
        const filteredSongs = allSongs.filter(song => {
            const matchCategoria = !categoria || song.categoria === categoria;
            const matchArgomento = !argomento || song.argomento === argomento;
            const matchBpm = !bpm || String(song.bpm) === bpm;
            return matchCategoria && matchArgomento && matchBpm;
        });
        renderSongs(filteredSongs);
      }

      // --- RENDER E GESTIONE EVENTI SUI BRANI (MODIFICATO) ---
      function renderSongs(songsToRender) {
        songListContainer.innerHTML = '';
        const playCounts = getPlayCounts();
        if (songsToRender.length > 0) {
          songsToRender.forEach(song => {
            const count = playCounts[song.id] || 0;
            const playsLeft = MAX_PLAYS - count;
            const isLocked = playsLeft <= 0;
            
            const hasLyrics = song.liriche && song.liriche.trim() !== "";
            const hasVideo = song.link_video && song.link_video.trim() !== "";
            
            const playBtnHTML = `<button class="btn playback-btn play-btn" title="Ascolta l'audio"><i class="fas ${isLocked ? 'fa-lock' : 'fa-play'}"></i></button>`;
            const videoBtnHTML = hasVideo ? `<button class="btn playback-btn video-btn" title="Guarda il video" data-video-src="${song.link_video}"><i class="fas ${isLocked ? 'fa-lock' : 'fa-video'}"></i></button>` : '';
            
            // --- MODIFICA: Icone e titolo dei pulsanti cambiano se bloccati ---
            const actionAudioBtn = `<button class="btn action-btn audio" title="${isLocked ? 'Limite ascolti raggiunto' : 'Ascolta l\'audio'}"><i class="fas ${isLocked ? 'fa-lock' : 'fa-headphones'}"></i> Audio</button>`;
            const actionVideoBtn = hasVideo ? `<button class="btn action-btn video" title="${isLocked ? 'Limite ascolti raggiunto' : 'Guarda il video'}" data-video-src="${song.link_video}"><i class="fas ${isLocked ? 'fa-lock' : 'fa-film'}"></i> Video</button>` : '<div></div>';
            const actionLyricsBtn = hasLyrics ? `<button class="btn action-btn lyrics" title="${isLocked ? 'Limite ascolti raggiunto' : 'Leggi il testo'}"><i class="fas ${isLocked ? 'fa-lock' : 'fa-file-lines'}"></i> Testo</button>` : '<div></div>';

            let purchaseBtnHTML = '';
            if (song.prezzo) { 
                const buttonText = `Acquista - €${song.prezzo}`;
                const stripeUrlWithId = song.stripe_link ? `${song.stripe_link}?client_reference_id=${song.id}` : '#';
                purchaseBtnHTML = `<a href="${stripeUrlWithId}" target="_blank" class="acquista-btn">${buttonText}</a>`;
            } else {
                purchaseBtnHTML = '<div></div>';
            }
            
            const infoBtnHTML = `<button class="btn info-btn top-row" title="Cosa include l'acquisto?"><i class="fas fa-info-circle"></i></button>`;
            
            let detailsHTML = '';
            if (song.bpm || song.durata) {
                detailsHTML = '<div class="song-details">';
                if (song.bpm) {
                    detailsHTML += `<span><i class="fas fa-tachometer-alt" style="margin-right: 5px;"></i>${song.bpm} BPM</span>`;
                }
                if (song.durata) {
                    detailsHTML += `<span><i class="far fa-clock" style="margin-right: 5px;"></i>${song.durata}</span>`;
                }
                detailsHTML += '</div>';
            }
            
            // --- MODIFICA: Testo esplicito per brani bloccati ---
            const playsLeftText = isLocked ? 'Limite ascolti raggiunto' : `Ascolti rimasti: ${playsLeft}`;

            const songItemHTML = `
              <div class="song-item ${isLocked ? 'disabled' : ''}" data-id="${song.id}" data-src="${song.link_ascolto}" data-title="${song.titolo}" data-lyrics="${hasLyrics ? song.liriche.replace(/"/g, '&quot;') : ''}">
                <div class="song-item-top">
                  <div class="song-playback-buttons">${playBtnHTML}${videoBtnHTML}</div>
                  <div class="song-info">
                    <span class="title">${song.titolo}</span>
                    <div class="plays-left">${playsLeftText}</div>
                    ${detailsHTML}
                  </div>
                  ${infoBtnHTML}
                </div>
                <div class="song-actions">
                  ${actionAudioBtn}
                  ${actionVideoBtn}
                  ${actionLyricsBtn}
                  ${purchaseBtnHTML}
                </div>
              </div>`;
            songListContainer.innerHTML += songItemHTML;
          });
          addEventListenersToSongs();
        } else { songListContainer.innerHTML = '<p>Nessun brano corrisponde ai filtri selezionati.</p>'; }
      }
      
      function addEventListenersToSongs() {
        document.querySelectorAll('.song-item').forEach(item => {
          if (item.classList.contains('disabled')) return; // Se disabilitato, non aggiungere nessun listener
          
          const videoSrc = item.querySelector('.video-btn')?.dataset.videoSrc || item.querySelector('.action-btn.video')?.dataset.videoSrc;
          item.querySelector('.title')?.addEventListener('click', () => handlePlay(item, 'audio'));
          item.querySelector('.play-btn')?.addEventListener('click', (e) => { e.stopPropagation(); handlePlay(item, 'audio'); });
          item.querySelector('.action-btn.audio')?.addEventListener('click', (e) => { e.stopPropagation(); handlePlay(item, 'audio'); });
          if (videoSrc) {
              item.querySelector('.video-btn')?.addEventListener('click', (e) => { e.stopPropagation(); handlePlay(item, 'video', videoSrc); });
              item.querySelector('.action-btn.video')?.addEventListener('click', (e) => { e.stopPropagation(); handlePlay(item, 'video', videoSrc); });
          }
          item.querySelector('.action-btn.lyrics')?.addEventListener('click', (e) => { e.stopPropagation(); showLyrics(item); });
          item.querySelector('.info-btn')?.addEventListener('click', (e) => { e.stopPropagation(); modals.purchaseInfo.style.display = 'flex'; });
        });
      }

      function showLyrics(item) {
        if(modals.lyrics) {
          const titleEl = modals.lyrics.querySelector('#lyrics-title');
          const textEl = modals.lyrics.querySelector('#lyrics-text');
          if(titleEl) titleEl.innerText = item.dataset.title;
          if(textEl) textEl.innerText = item.dataset.lyrics || "Testo non disponibile.";
          modals.lyrics.style.display = 'flex';
        }
      }

      function handlePlay(item, type, sourceUrl = null) {
          const isPlayingThisItem = item === currentPlayingItem;
          const isSameType = type === currentPlayingType;

          if (isPlayingThisItem && isSameType) {
              if (type === 'audio') { audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause(); }
              else { videoPlayer.paused ? videoPlayer.play() : videoPlayer.pause(); }
          } else {
              if (!isPlayingThisItem) {
                  const counts = getPlayCounts();
                  const songId = item.dataset.id;
                  let count = counts[songId] || 0;
                  if (count < MAX_PLAYS) {
                    count++;
                    counts[songId] = count;
                    savePlayCounts(counts);
                    trackPlay(songId);
                    // Ricarica la lista per mostrare il numero aggiornato di ascolti e bloccare se necessario
                    applyFilters(); 
                  } else {
                    // Se si tenta di riprodurre un brano già bloccato, non fare nulla.
                    return;
                  }
              }
              resetPlayingState();
              currentPlayingItem = item;
              currentPlayingType = type;
              if (type === 'audio') {
                  footerPlayer.classList.add('visible');
                  footerPlayerTitle.textContent = item.dataset.title;
                  audioPlayer.src = item.dataset.src;
                  audioPlayer.play();
              } else {
                  videoPlayer.src = sourceUrl;
                  modals.video.style.display = 'flex';
                  videoPlayer.play();
              }
          }
      }
      
      function resetPlayingState() {
          if (currentPlayingItem) { currentPlayingItem.classList.remove('playing-audio', 'playing-video'); }
          currentPlayingItem = null;
          currentPlayingType = null;
          footerPlayer.classList.remove('visible');
          audioPlayer.pause();
          audioPlayer.src = '';
      }
      
      function updatePlayingUI() {
          if (currentPlayingItem) {
              document.querySelectorAll('.song-item').forEach(item => item.classList.remove('playing-audio', 'playing-video'));
              if (currentPlayingType === 'audio') { currentPlayingItem.classList.add('playing-audio'); }
              else { currentPlayingItem.classList.add('playing-video'); }
          }
      }

      function updatePausedUI() {
          document.querySelectorAll('.song-item').forEach(item => item.classList.remove('playing-audio', 'playing-video'));
      }
      
      audioPlayer.addEventListener('play', updatePlayingUI);
      videoPlayer.addEventListener('play', updatePlayingUI);
      audioPlayer.addEventListener('pause', updatePausedUI);
      videoPlayer.addEventListener('pause', updatePausedUI);
      audioPlayer.addEventListener('ended', resetPlayingState);
      videoPlayer.addEventListener('ended', closeAllModals);
    });
  </script>

</body>
</html>
